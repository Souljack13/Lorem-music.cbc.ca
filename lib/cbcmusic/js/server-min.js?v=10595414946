/*
 * Commons
 * Copyright(c), CBC Radio 3.
 */


(function(){var day=24*60*60*1000;var zeroPad=function(number,digits){number=String(number);while(number.length<digits)number='0'+number;return number;};var multipliers={millisecond:1,second:1000,minute:60*1000,hour:60*60*1000,day:day,week:7*day,month:{add:function(d,number){multipliers.year.add(d,Math[number>0?'floor':'ceil'](number/12));var prevMonth=d.getMonth()+(number%12);if(prevMonth==12){prevMonth=0;d.setYear(d.getFullYear()+1);}else if(prevMonth==-1){prevMonth=11;d.setYear(d.getFullYear()-1);}
d.setMonth(prevMonth);},diff:function(d1,d2){var diffYears=d1.getFullYear()-d2.getFullYear();var diffMonths=d1.getMonth()-d2.getMonth()+(diffYears*12);var diffDays=d1.getDate()-d2.getDate();return diffMonths+(diffDays/30);}},year:{add:function(d,number){d.setYear(d.getFullYear()+Math[number>0?'floor':'ceil'](number));},diff:function(d1,d2){return multipliers.month.diff(d1,d2)/12;}}};for(var unit in multipliers){if(unit.substring(unit.length-1)!='s'){multipliers[unit+'s']=multipliers[unit];}}
var format=function(d,code){if(Date.prototype.strftime.formatShortcuts[code]){return d.strftime(Date.prototype.strftime.formatShortcuts[code]);}else{var getter=(Date.prototype.strftime.formatCodes[code]||'').split('.');var nbr=d['get'+getter[0]]?d['get'+getter[0]]():'';if(getter[1])nbr=zeroPad(nbr,getter[1]);return nbr;}};var instanceMethods={succ:function(unit){return this.clone().add(1,unit);},add:function(number,unit){var factor=multipliers[unit]||multipliers.day;if(typeof factor=='number'){this.setTime(this.getTime()+(factor*number));}else{factor.add(this,number);}
return this;},diff:function(dateObj,unit,allowDecimal){dateObj=Date.create(dateObj);if(dateObj===null)return null;var factor=multipliers[unit]||multipliers.day;if(typeof factor=='number'){var unitDiff=(this.getTime()-dateObj.getTime())/factor;}else{var unitDiff=factor.diff(this,dateObj);}
return(allowDecimal?unitDiff:Math[unitDiff>0?'floor':'ceil'](unitDiff));},strftime:function(formatStr){var source=formatStr||'%Y-%m-%d',result='',match;while(source.length>0){if(match=source.match(Date.prototype.strftime.formatCodes.matcher)){result+=source.slice(0,match.index);result+=(match[1]||'')+format(this,match[2]);source=source.slice(match.index+match[0].length);}else{result+=source,source='';}}
return result;},getShortYear:function(){return this.getYear()%100;},getMonthNumber:function(){return this.getMonth()+1;},getMonthName:function(){return Date.MONTHNAMES[this.getMonth()];},getAbbrMonthName:function(){return Date.ABBR_MONTHNAMES[this.getMonth()];},getDayName:function(){return Date.DAYNAMES[this.getDay()];},getAbbrDayName:function(){return Date.ABBR_DAYNAMES[this.getDay()];},getDayOrdinal:function(){return Date.ORDINALNAMES[this.getDate()%10];},getHours12:function(){var hours=this.getHours();return hours>12?hours-12:(hours==0?12:hours);},getAmPm:function(){return this.getHours()>=12?'PM':'AM';},getUnix:function(){return Math.round(this.getTime()/1000,0);},getGmtOffset:function(){var hours=this.getTimezoneOffset()/60;var prefix=hours<0?'+':'-';hours=Math.abs(hours);return prefix+zeroPad(Math.floor(hours),2)+':'+zeroPad((hours%1)*60,2);},getTimezoneName:function(){var match=/(?:\((.+)\)$| ([A-Z]{3}) )/.exec(this.toString());return match[1]||match[2]||'GMT'+this.getGmtOffset();},toYmdInt:function(){return(this.getFullYear()*10000)+(this.getMonthNumber()*100)+this.getDate();},clone:function(){return new Date(this.getTime());}};for(var name in instanceMethods)Date.prototype[name]=instanceMethods[name];var staticMethods={create:function(date){if(date instanceof Date)return date;if(typeof date=='number')return new Date(date*1000);var parsable=String(date).replace(/^\s*(.+)\s*$/,'$1'),i=0,length=Date.create.patterns.length,pattern;var current=parsable;while(i<length){ms=Date.parse(current);if(!isNaN(ms))return new Date(ms);pattern=Date.create.patterns[i];if(typeof pattern=='function'){obj=pattern(current);if(obj instanceof Date)return obj;}else{current=parsable.replace(pattern[0],pattern[1]);}
i++;}
return NaN;},MONTHNAMES:'January February March April May June July August September October November December'.split(' '),ABBR_MONTHNAMES:'Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec'.split(' '),DAYNAMES:'Sunday Monday Tuesday Wednesday Thursday Friday Saturday'.split(' '),ABBR_DAYNAMES:'Sun Mon Tue Wed Thu Fri Sat'.split(' '),ORDINALNAMES:'th st nd rd th th th th th th'.split(' '),ISO:'%Y-%m-%dT%H:%M:%S.%N%G',SQL:'%Y-%m-%d %H:%M:%S',daysInMonth:function(year,month){if(month==2)
return new Date(year,1,29).getDate()==29?29:28;return[undefined,31,undefined,31,30,31,30,31,31,30,31,30,31][month];}};for(var name in staticMethods)Date[name]=staticMethods[name];Date.prototype.strftime.formatCodes={matcher:/()%(#?(%|[a-z]))/i,Y:'FullYear',y:'ShortYear.2',m:'MonthNumber.2','#m':'MonthNumber',B:'MonthName',b:'AbbrMonthName',d:'Date.2','#d':'Date',e:'Date',A:'DayName',a:'AbbrDayName',w:'Day',o:'DayOrdinal',H:'Hours.2','#H':'Hours',I:'Hours12.2','#I':'Hours12',p:'AmPm',M:'Minutes.2','#M':'Minutes',S:'Seconds.2','#S':'Seconds',s:'Unix',N:'Milliseconds.3','#N':'Milliseconds',O:'TimezoneOffset',Z:'TimezoneName',G:'GmtOffset'};Date.prototype.strftime.formatShortcuts={F:'%Y-%m-%d',T:'%H:%M:%S',X:'%H:%M:%S',x:'%m/%d/%y',D:'%m/%d/%y','#c':'%a %b %e %H:%M:%S %Y',v:'%e-%b-%Y',R:'%H:%M',r:'%I:%M:%S %p',t:'\t',n:'\n','%':'%'};Date.create.patterns=[[/-/g,'/'],[/st|nd|rd|th/g,''],[/(3[01]|[0-2]\d)\s*\.\s*(1[0-2]|0\d)\s*\.\s*([1-9]\d{3})/,'$2/$1/$3'],[/([1-9]\d{3})\s*-\s*(1[0-2]|0\d)\s*-\s*(3[01]|[0-2]\d)/,'$2/$3/$1'],function(str){var match=str.match(/^(?:(.+)\s+)?([1-9]|1[012])(?:\s*\:\s*(\d\d))?(?:\s*\:\s*(\d\d))?\s*(am|pm)\s*$/i);if(match){if(match[1]){var d=Date.create(match[1]);if(isNaN(d))return;}else{var d=new Date();d.setMilliseconds(0);}
var hour=parseFloat(match[2]);hour=match[5].toLowerCase()=='am'?(hour==12?0:hour):(hour==12?12:hour+12);d.setHours(hour,parseFloat(match[3]||0),parseFloat(match[4]||0));return d;}}];})();var $D=Date.create;

if(typeof CBCR3=="undefined"||!CBCR3){var CBCR3={};}
var debug=false;var traceCount=0;function docDomain(){var myDomain=window.location.hostname;var isLive=myDomain.search("cbc.ca");if(isLive>-1){return document.domain="cbc.ca";}else{return null;}}
CBCR3.namespace=function(){var a=arguments,o=null,i,j,d;for(i=0;i<a.length;i=i+1){d=(""+a[i]).split(".");o=CBCR3;for(j=(d[0]=="CBCR3")?1:0;j<d.length;j=j+1){o[d[j]]=o[d[j]]||{};o=o[d[j]];}}
return o;}
var Trace={log:function(obj){this._outputToConsole(obj);},error:function(error){var fileName=error.fileName;var lineNumber=error.lineNumber;this._outputToConsole("ERROR - message: "+error.message+" error:"+error+" fileName: "+fileName+" lineNumber: "+lineNumber);},write:function(obj,overwrite){if(debug){this._outputToConsole(obj);}else{if(overwrite)
this._outputToConsole(obj);}},_outputToConsole:function(obj){if(!window.top.location.href.toQueryParams().debug)
return;if(typeof window.opera!="undefined")
window.opera.postError(obj);if(typeof console!="undefined"){traceCount++;console.log(this._source+" "+traceCount+":");console.log(obj);}},_source:""};if(!Array.prototype.filter)
{Array.prototype.filter=function(fun)
{var len=this.length>>>0;if(typeof fun!="function")
throw new TypeError();var res=new Array();var thisp=arguments[1];for(var i=0;i<len;i++)
{if(i in this)
{var val=this[i];if(fun.call(thisp,val,i,this))
res.push(val);}}
return res;};}
var CBCDetect={isIE:function(){var isMinIE10=!!window.MSStream;return(Prototype&&Prototype.Browser)?(isMinIE10||Prototype.Browser.IE):isMinIE10;}};function isIE(v){var isMinIE10=!!window.MSStream;alert(isMinIE10);return(isMinIE10||Prototype.Browser.IE);}
CBCR3.environment=function()
{if(!top.document._r3Environment)
top.document._r3Environment={};return top.document._r3Environment;};

CBCR3.namespace("CBCR3.Commons");CBCR3.Commons.Cookies={create:function(name,value,days,mins,domain,path){var expires;if(days&&days!=0){var date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));expires="; expires="+date.toGMTString();}
else
expires="";if(mins&&mins!=0){var date=new Date();date.setTime(date.getTime()+(mins*60*1000));expires="; expires="+date.toGMTString();}
var domainSegment=(domain)?"; domain="+domain:"";var pathSegment=(path)?"; path=/"+path:"; path=/";var newCookie=name+"="+value+expires+domainSegment+pathSegment;document.cookie=newCookie;},getValue:function(name){var nameEQ=name+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' '){c=c.substring(1,c.length);}
if(c.indexOf(nameEQ)==0){return c.substring(nameEQ.length,c.length);}}
return null;},deleteCookie:function(name){this.create(name,"",-1);}};

CBCR3.namespace("CBCR3.Commons");CBCR3.Commons.Event=Class.create({initialize:function(type,data,target)
{this.type=type;this.data=data;this.target=target;}});

CBCR3.namespace("CBCR3.Commons");CBCR3.Commons.EventDispatcher=Class.create({listenerChain:null,debug:false,initialize:function(){},buildListenerChain:function(){if(!this.listenerChain)
this.listenerChain={};},getListeners:function(){return(this.listenerChain)?this.listenerChain:null;},addEventListener:function(type,listener){if(!listener instanceof Function)
alert("Listener isn't a function");this.buildListenerChain();if(!this.listenerChain[type])
this.listenerChain[type]=[listener];else
this.listenerChain[type].push(listener);},hasEventListener:function(type){if(this.listenerChain)
return(typeof this.listenerChain[type]!="undefined");return false;},removeEventListenerType:function(type){if(!this.hasEventListener(type))
return false;this.listenerChain[type]=[];},removeEventListener:function(type,listener){if(!this.hasEventListener(type))
return false;Trace.write("METANODE: removeEventListener BEFORE",this.debug);Trace.write(this.listenerChain[type],this.debug);Trace.write(listener,this.debug);Trace.write(this.listenerChain,this.debug);for(var i=0;i<this.listenerChain[type].length;i++){if(this.listenerChain[type][i]==listener){Trace.write("equal",this.debug);this.listenerChain[type].splice(i,1);}}
Trace.write("METANODE: removeEventListener AFTER",this.debug);Trace.write(this.listenerChain,this.debug);},clearEventListeners:function(){this.listenerChain={};},dispatchEvent:function(type,data,target){var event;if(typeof type==="object"){event=type;type=event.type;}
else
event=new CBCR3.Commons.Event(type,data,target||this);this.buildListenerChain();if(!this.hasEventListener(type))
return false;this.listenerChain[type].any(function(funct){return(funct(event)==false?true:false);});}});

CBCR3.namespace("CBCR3.Commons");CBCR3.Commons.MapperBase=Class.create({mapCollection:function(dtos)
{var collection=new Array();if(dtos!=null&&dtos instanceof Array)
for(var i=0;i<dtos.length;i++)
collection.push(this.mapFrom(dtos[i]))
return collection;},mapFrom:function(dto)
{throw"This function must be overridden by a sub class";}});

CBCR3.namespace("CBCR3.Models");CBCR3.Models.StreamCategory=Class.create(CBCR3.Commons.EventDispatcher,{stations:null,name:null,initialize:function($super,opts){$super();this.stations=new Array();this.name=opts.name;},addStation:function(station){this.stations.push(station);}});CBCR3.Models.StreamStation=Class.create(CBCR3.Commons.EventDispatcher,{id:null,roomid:null,fullroomid:null,permalink:null,debug:false,name:null,mount:null,isspecial:false,specialurl:null,specialimage:null,category:null,secondCategory:null,showcomposer:false,network:null,playpreroll:false,prerollTarget:null,geofenced:false,disabled:false,initialize:function($super,opts){try{$super();this.id=this.stripId(opts.id)||"";this.roomid=opts.roomid;this.fullroomid=opts.fullroomid;this.name=opts.name;this.mount=opts.mount;this.isspecial=opts.isspecial;this.specialurl=opts.specialurl;this.specialimage=opts.specialimage;this.category=opts.category,this.playpreroll=opts.playpreroll,this.secondCategory=opts.secondCategory;this.showcomposer=opts.showcomposer||false;this.permalink=opts.permalink;this.geofenced=opts.geofenced;this.disabled=opts.disabled;this.prerollTarget=opts.prerollTarget||null;}catch(e){Trace.error(e);}},stripId:function(id){var tmpId=id.sub("/","");return tmpId.gsub("/","-");}});

CBCR3.namespace("CBCR3.Services");CBCR3.Services.AudioStreamService=Class.create(CBCR3.Commons.EventDispatcher,{initialize:function($super){$super();}});var _audioStreamManager=null;CBCR3.namespace("CBCR3.Models");CBCR3.Models.AudioStreamManagerProvider={getInstance:function(){if(_audioStreamManager==null)
_audioStreamManager=new CBCR3.Models.AudioStreamManager();return _audioStreamManager;}};CBCR3.Models.AudioStreamManager=Class.create(CBCR3.Commons.EventDispatcher,{streams:null,categories:null,debug:false,isReady:false,processed:false,initialize:function($super){$super();this.streams=new Array();this.categories=new Object();},processJSONStreams:function(streamsJSON){Trace.write("processJSONStreams",true);Trace.write(streamsJSON,true);for(var i=0;i<streamsJSON.length;i++){var stream=this.mapStation(streamsJSON[i]);if(!stream.disabled){if(!this.categories[stream.category]){this.categories[stream.category]=new CBCR3.Models.StreamCategory({name:stream.category});}
this.categories[stream.category].addStation(stream);if(stream.secondCategory!=null){if(!this.categories[stream.secondCategory])
this.categories[stream.secondCategory]=new CBCR3.Models.StreamCategory({name:stream.secondCategory});this.categories[stream.secondCategory].addStation(stream);}
this.streams.push(stream);}}
this.processed=true;this.sendCategories();},sendCategories:function(){if(this.isReady&&this.processed)
this.dispatchEvent("streamPanel:streamInfoloaded",{categories:this.categories});},setReady:function(isReady){this.isReady=isReady;this.sendCategories();},unload:function(){this.setReady(false);this.removeEventListenerType("streamPanel:streamInfoloaded");},mapStation:function(stream){var strCategoryName=(stream.Category=="Radio2")?"CBC Radio 2":stream.Category;var secCat=null;if(stream.Name.indexOf("Heppner")>-1)
secCat="hepp";if(stream.SecondCategory!=null)
secCat=stream.SecondCategory;if(stream.PreRollAdTarget!=null&&stream.PreRollAdTarget!="")
Trace.write("PREROLLTARGET:"+stream.PreRollAdTarget,true);return new CBCR3.Models.StreamStation({name:stream.Name,id:stream.NodeKeyCurrentAndPreviousSong,fullroomid:stream.NodeKeyCurrentAndPreviousSong,roomid:stream.NodeKeyCurrentSong,disabled:stream.Disabled,mount:stream.MountName,permalink:stream.Permalink,isspecial:stream.IsSpecialStream,specialurl:stream.AdUrl,specialimage:stream.AdUrlSmall,category:strCategoryName,secondCategory:stream.SecondCategory,showcomposer:stream.ShowComposer,network:null,playpreroll:stream.PlayPrerollAd,prerollTarget:stream.PreRollAdTarget,geofenced:stream.GeoFenced});},getStreamsByCategory:function(category){Trace.write("*** category:"+category,true);var categoryStreams=new Array();if(category==null)
return"";category=category.toLowerCase();Trace.write(this.streams,true);for(var i=0;i<this.streams.length;i++){if(this.streams[i].category!=null){var streamCategory=this.streams[i].category.toLowerCase();if(streamCategory==category)
categoryStreams.push(this.streams[i]);}
if(this.streams[i].secondCategory!=null){var secondCategory=this.streams[i].secondCategory.toLowerCase();if(secondCategory==category)
categoryStreams.push(this.streams[i]);}}
return categoryStreams;},getStreamByPermalink:function(permalink){Trace.write("*** permalink:"+permalink+" streams->",true);if(permalink==null)
return"";var index=permalink.indexOf("/stream/");var tmpPermalink=permalink.substring(index);Trace.write(this.streams,true);for(var i=0;i<this.streams.length;i++){if(this.streams[i].permalink!=null&&this.streams[i].permalink==tmpPermalink)
return this.streams[i];}
return null;},getStreamByRoomId:function(roomid){this.streams.each(function(stream){if(stream.roomid!=null&&stream.roomid==roomid)
return stream;});return null;}});

CBCR3.namespace("CBCR3.Services");CBCR3.Services.MusicService=Class.create(CBCR3.Commons.EventDispatcher,{END_OF_PLAYLIST:"End of Playlist",ONLY_IN_CANADA:"This track is only available to those within Canada.",initialize:function($super){$super();},getPlaylist:function(playlistPermalink){CBC.Radio3.Player.Web.PlayerWebService.GetPlaylist(playlistPermalink,this.getPlaylist_Success.bind(this),this.webService_Failed.bind(this));},getTrack:function(permalink,sequence){CBC.Radio3.Player.Web.PlayerWebService.GetPlaylistTrack(permalink,sequence,this.getTrack_Success.bind(this),this.webService_Failed.bind(this));},getPollTrack:function(permalink,sequence){CBC.Radio3.Player.Web.PlayerWebService.GetPollPlaylistTrack(permalink,sequence,this.getTrack_Success.bind(this),this.webService_Failed.bind(this));},getPrevPollTrack:function(permalink,sequence,isShuffle){CBC.Radio3.Player.Web.PlayerWebService.GetPreviousPollPlaylistTrack(permalink,sequence,isShuffle,this.getTrack_Success.bind(this),this.webService_Failed.bind(this));},getNextPollTrack:function(permalink,sequence,isShuffle){CBC.Radio3.Player.Web.PlayerWebService.GetNextPollPlaylistTrack(permalink,sequence,isShuffle,this.getTrack_Success.bind(this),this.webService_Failed.bind(this));},getPollTrackByPermalink:function(permalink,promoUrl){CBC.Radio3.Player.Web.PlayerWebService.GetPollPlaylistTrackByPermalink(permalink,promoUrl,this.getTrack_Success.bind(this),this.webService_Failed.bind(this));},getNextTrack:function(permalink,sequence,isShuffle){CBC.Radio3.Player.Web.PlayerWebService.GetNextPlaylistTrack(permalink,sequence,isShuffle,this.getTrack_Success.bind(this),this.webService_Failed.bind(this));},getPrevTrack:function(permalink,sequence,isShuffle){CBC.Radio3.Player.Web.PlayerWebService.GetPreviousPlaylistTrack(permalink,sequence,isShuffle,this.getTrack_Success.bind(this),this.webService_Failed.bind(this));},getTrack_Success:function(response){Trace.write("getTrack_Success",true);Trace.write(response,true);if(response!=null){var track=(response.Payload!=null)?new CBCR3.Player.Mappers.PlaylistTrackDtoMapper().mapFrom(response.Payload):null;if(response.Successful){this.dispatchEvent(CBCR3.Player.Events.ServiceEvent.trackReceived,{track:track});}else
{if(response.ErrorMessage==this.END_OF_PLAYLIST){this.dispatchEvent(CBCR3.Player.Events.ServiceExceptionEvent.endOfPlaylist,{message:response.ErrorMessage});}else if(response.ErrorMessage==this.ONLY_IN_CANADA){this.dispatchEvent(CBCR3.Player.Events.ServiceExceptionEvent.userOutsideCanada,{message:response.ErrorMessage,track:track});}}}},getPlaylist_Success:function(response){var playlist=this.parsePlaylist(response);this.dispatchEvent(CBCR3.Player.Events.ServiceEvent.playlistReceived,{playlist:playlist});},parsePlaylist:function(playlistDto){return new CBCR3.Mappers.PlaylistDtoMapper().mapFrom(playlistDto);},webService_Failed:function(errorResponse){var exception=new CBCR3.Player.Exceptions.SoapExceptionFactory().createException(errorResponse);var type=new CBCR3.Player.Exceptions.SoapExceptionLookup().map(exception.type);this.dispatchEvent(type,{exception:exception});}});

CBCR3.namespace("CBCR3.Services");CBCR3.Services.LoggingService=Class.create(CBCR3.Commons.EventDispatcher,{initialize:function($super)
{$super();},logTrackPlay:function(trackPermalink)
{CBC.Radio3.Player.Web.PlayerWebService.LogTrackPlay(trackPermalink,this.logTrackPlay_Success.bind(this),this.webService_Failed.bind(this));},logTrackPlay_Success:function(response,context)
{},webService_Failed:function(errorResponse)
{var exception=new CBCR3.Player.Exceptions.SoapExceptionFactory().createException(errorResponse);var type=new CBCR3.Player.Exceptions.SoapExceptionLookup().map(exception.type);this.dispatchEvent(type,{exception:exception});}});

CBCR3.namespace("CBCR3.Services");var _permalinkServices=null;CBCR3.Services.PermalinkServiceProvider=Class.create({getInstance:function(){if(_permalinkServices==null)
_permalinkServices=CBCR3.Services.PermalinkService();return _permalinkServices;}});CBCR3.Services.PermalinkService=Class.create(CBCR3.Commons.EventDispatcher,{initialize:function($super){$super();},addTrackToPlaylist:function(trackPermalink,playlistPermalink,allowDuplicates){CBC.Radio3.Player.Web.PlayerWebService.AddTrackToPlaylist(trackPermalink,playlistPermalink,allowDuplicates,this.addTrackToPlaylist_Success.bind(this),this.webService_Failed.bind(this),{trackPermalink:trackPermalink,playlistPermalink:playlistPermalink});},addTrackToPlaylist_Success:function(response,userContext){if(response==-1)
{this.dispatchEvent(CBCR3.Player.Events.ServiceExceptionEvent.duplicateTrack,{elementId:userContext.elementId,playlistPermalink:userContext.playlistPermalink});}
else{this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.trackAdded,{trackPermalink:userContext.trackPermalink,playlistPermalink:userContext.playlistPermalink,sequence:response});}},addTrackToPlaylist_failed:function(response,userContext){var exParser=new CBCR3.Player.Exceptions.SoapExceptionParser();var exception=exParser.parseException(response);this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.trackExists,{elementId:userContext.elementId,playlistPermalink:userContext.playlistPermalink});},addLike:function(permalink){try{CBC.Radio3.Web.WebServices.LikeWebService.Like(permalink,this.addLike_Success.bind(this),this.webService_Failed.bind(this));}catch(e){Trace.error(e);}},addPlaylistToFavourites_Success:function(response,userContext){this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.favouriteAdded);},addLike_Success:function(response,userContext){this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.favouriteAdded);},getFavouriteStatus:function(playlistPermalink){CBC.Radio3.Player.Web.PlayerWebService.GetFavouriteStatus(playlistPermalink,this.getFavouriteStatus_Success.bind(this),this.webService_Failed.bind(this));},getFavouriteStatus_Success:function(response,userContext){this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.favouriteStatus,{favouriteStatus:response});},removePlaylistFromFavourites:function(playlistPermalink,elementId){CBC.Radio3.Player.Web.PlayerWebService.RemovePlaylistFromFavourites(playlistPermalink,this.removePlaylistFromFavourites_Success.bind(this),this.webService_Failed.bind(this),{elementId:elementId,playlistPermalink:playlistPermalink});},removePlaylistFromFavourites_Success:function(response,context){var elementId=context.elementId;var playlistPermalink=context.playlistPermalink;this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.favouriteRemoved,{id:elementId,playlistPermalink:playlistPermalink});},getPermalinkContext:function(playlistPermalink){CBC.Radio3.Player.Web.PlayerWebService.GetPermalinkContext(playlistPermalink,this.getPermalinkContext_Success.bind(this),this.webService_Failed.bind(this));},getPermalinkContext_Success:function(response,context){var playlistContext=new CBCR3.Player.Models.PlaylistPermalinkContext({title:response.Title,infoLink:response.InfoLink,details:response.Details,detailLink:response.DetailLink});this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.permalinkContextReceived,{permalinkContext:playlistContext});},webService_Failed:function(errorResponse){Trace.write("ERROR in permalinkservice -> webService_Failed()",true);Trace.error(errorResponse);var exception=new CBCR3.Player.Exceptions.SoapExceptionFactory().createException(errorResponse);var type=new CBCR3.Player.Exceptions.SoapExceptionLookup().map(exception.type);this.dispatchEvent(type,{exception:exception});}});

CBCR3.namespace("CBCR3.Services");CBCR3.Services.AutoplayService=Class.create(CBCR3.Commons.EventDispatcher,{initialize:function($super){$super();},getStreamPermalinkFromPlaylistPermalink:function(playlistPermalink){CBC.Radio3.Web.WebServices.AutoplayStreamWebService.StreamPermalinkFromPlaylistPermalink(playlistPermalink,this._streamPermalinkFromPlaylistPermalink_success.bind(this),this.webService_Failed.bind(this),{playlistPermalink:playlistPermalink});},_streamPermalinkFromPlaylistPermalink_success:function(response,context){this.dispatchEvent(CBCR3.Player.Events.AutoplayStream.permalinkReceived,{streamPermalink:response});},webService_Failed:function(errorResponse){Trace.write("ERROR in autoplayservice -> webService_Failed()",true);Trace.error(errorResponse);var exception=new CBCR3.Player.Exceptions.SoapExceptionFactory().createException(errorResponse);var type=new CBCR3.Player.Exceptions.SoapExceptionLookup().map(exception.type);this.dispatchEvent(type,{exception:exception});}});

CBCR3.namespace("CBCR3.Services");var serviceConfig={musicService:CBCR3.Services.MusicService,loggingService:CBCR3.Services.LoggingService,permalinkService:CBCR3.Services.PermalinkService,autoplayService:CBCR3.Services.AutoplayService,playlistService:CBCR3.Services.PlaylistService,thumbService:CBCR3.Services.ThumbService};var staticContainer={};CBCR3.Services.ServicesProvider={getInstanceOf:function(serviceType){if(serviceConfig[serviceType]==null)
alert("Unknown service type in ServiceProvider: "+serviceType);if(staticContainer[serviceType]==null)
staticContainer[serviceType]=new serviceConfig[serviceType]();return staticContainer[serviceType];}};

CBCR3.namespace("CBCR3.Services");var _nodeSocketService=null;CBCR3.Services.NodeSocketServiceProvider={getInstance:function(socketio){if(_nodeSocketService==null)
_nodeSocketService=new CBCR3.Services.NodeSocketService(socketio);return _nodeSocketService;}};CBCR3.Services.NodeSocketService=Class.create(CBCR3.Commons.EventDispatcher,{metarooms:null,roomsArr:null,data:null,debug:true,socketio:null,funcOnPush:null,funcOnFullPush:null,playerRoom:null,webstationrooms:null,pushSet:false,page:null,timestamp:null,connected:false,siteLoaded:false,exceptionHdr:"nodesocketservice exception:",streamsToIgnore:parent.tangoMetadataStreamsToIgnore,initialize:function($super,socketio){$super();this.metarooms=new Array();this.webstationrooms=new Array();this.roomsArr=new Array();this.timestamp=new Date();this.page=document.location;this.socketio=socketio;this.init();},init:function(){try{if(typeof Trace=='undefined'){Trace.write(this.exceptionHdr+" init(): Trace is undefined",true);}else{Trace.write("nodesocketservice.js -> init() timestamp:"+this.timestamp+" page:"+this.page,this.debug);Trace.write(this,this.debug);}
if(this.socketio){this.socketio.on('connect',this.onConnect.bind(this));this.socketio.on('disconnect',this.onDisconnect.bind(this));}}catch(e){Trace.write(this.exceptionHdr+" init():"+e.message,true);Trace.error(e);}},setPush:function(){if(this.pushSet)
return;if(this.socketio){this.socketio.on('push',this.onPush.bind(this));this.pushSet=true;}else{Trace.write(this.exceptionHdr+" setPush(): Error this.socketio is null",true);}},setSiteLoaded:function(setting){this.siteLoaded=setting;},resetPush:function(){this.pushSet=false;},clearWebStations:function(){this.webstationrooms.each(function(webstation){if(!this.metarooms[webstation]){this.socketio.emit('leave',webstation);this.removeRoomId(webstation);}});this.webstationrooms=new Array();},disconnect:function(){try{if(typeof Trace=='undefined'){Trace.write(this.exceptionHdr+" disconnect(): Trace is undefined",true);}else{Trace.write('nodesocketservice.js -> timestamp: '+this.timestamp+' disconnect()'+this.timestamp,this.debug);}
if(this.socketio)
this.socketio.emit('disconnect');}catch(e){Trace.write(this.exceptionHdr+" disconnect():"+e.message,true);Trace.error(e);}},joinPlayerRoom:function(roomid){try{this.setPush();Trace.write("nodesocketservice.js -> timestamp: "+this.timestamp+" metarooms[roomid]:"+this.metarooms[roomid]+" joinPlayerRoom() page:"+this.page+" roomid:"+roomid+" playerRoomid:"+this.playerRoom,this.debug);if(this.streamsToIgnore.indexOf(roomid)!=-1)
return;if(this.playerRoom)
this.leavePlayerRoom(this.playerRoom);if(!this.metarooms[roomid])
this.metarooms[roomid]=roomid;this.playerRoom=roomid;if(this.connected)
this.socketio.emit('join',roomid);}catch(e){Trace.write(this.exceptionHdr+" joinPlayerRoom():"+e.message,true);Trace.error(e);}},leavePlayerRoom:function(roomid){try{Trace.write("nodesocketservice.js -> timestamp: "+this.timestamp+" leavePlayerRoom() metarooms[roomid]: "+this.metarooms[roomid]+" roomid:"+roomid+" playerRoom:"+this.playerRoom,this.debug);if(!this.metarooms[roomid])
this.socketio.emit('leave',roomid);}catch(e){Trace.write(this.exceptionHdr+" leavePlayerRoom():"+e.message,true);Trace.error(e);}},joinWebStationRoom:function(roomid){try{this.setPush();if(this.streamsToIgnore.indexOf(roomid)!=-1)
return;if(!this.webstationrooms[roomid])
this.webstationrooms[roomid]=roomid;if(this.connected)
this.socketio.emit('join',roomid);}catch(e){Trace.write(this.exceptionHdr+" joinWebStationRoom():"+e.message,true);Trace.error(e);}},joinRoom:function(roomid){try{this.setPush();if(this.streamsToIgnore.indexOf(roomid)!=-1)
return;Trace.write("nodesocketservice -> timestamp: "+this.timestamp+" joinRoom() roomid:"+roomid,true);if(this.connected)
this.socketio.emit('join',roomid);if(!this.metarooms[roomid])
this.metarooms[roomid]=roomid;if(this.roomsArr.indexOf(roomid)<0)
this.roomsArr.push(roomid);}catch(e){Trace.write(this.exceptionHdr+" joinRoom():"+e.message,true);Trace.error(e);}},leaveRoom:function(roomid){try{if(this.metarooms[roomid]){Trace.write("nodesocketservice -> timestamp: "+this.timestamp+" leaveRoom - > "+roomid+"< playerRoom:"+this.playerRoom+"<",this.debug);if(this.playerRoom==roomid||this.webstationrooms[roomid])
return;this.socketio.emit('leave',roomid);this.roomsArr=this.removeRoomId(roomid);delete this.metarooms[roomid];}}catch(e){Trace.write(this.exceptionHdr+" leaveRoom():"+e.message,true);Trace.error(e);}},removeRoomId:function(roomid){var tmpArr=new Array();this.roomsArr.each(function(item){if(item!=roomid)tmpArr.push(item);});return tmpArr;},onPush:function(event){try{Trace.write("nodesocketservice.js -> onPush()",this.debug);Trace.write(event,this.debug);if(!this.siteLoaded)
return;var metadata=this.processData({key:event.key,value:event.value});Trace.write("nodesocketservice onPush() Metadata: ",this.debug);Trace.write(metadata,this.debug);if(this.playerRoom==event.key)
this.dispatchEvent("metaNode:playerupdated",{value:metadata});this.dispatchEvent("metaNode:updated",{value:metadata});}catch(e){Trace.write("nodesocketservice.js -> ERROR onPush(): siteloaded:"+this.siteLoaded+" location:"+document.location,true);Trace.error(e);}},reloadData:function(){Trace.write("nodesocketservice.js -> reloadData() ",true);this.onConnect();},onConnect:function(event){try{Trace.write("NODESOCKETSERVICE: onConnect in nodesocketservice.js",this.debug);Trace.write(this,this.debug);this.connected=true;var self=this;this.roomsArr.each(function(roomid){if(self.metarooms!=null&&self.metarooms[roomid])
self.joinRoom(roomid);});if(this.playerRoom)
this.joinPlayerRoom(this.playerRoom);this.dispatchEvent("metaNode:connected");}catch(e){Trace.write(this.exceptionHdr+" onConnect():"+e.message,true);Trace.error(e);}},onDisconnect:function(event){Trace.write("NODESOCKETSERVICE: onDisconnect in nodesocketservice.js",this.debug);this.connected=false;this.dispatchEvent("metaNode:disconnected");},processData:function(data){try{if(data.key.indexOf('/metadata/now/')!=-1){Trace.write(data,this.debug);var myObject=eval('('+data.value+')');var stream=myObject;var datatrack=(stream.tracks&&stream.tracks.length>0)?stream.tracks[0]:{thumbnail:"",artist:"",title:""};var track=this.mapTrack(datatrack);var tracksArr=new Array();tracksArr.push(track);return{rawData:data.value,key:data.key,getNowPlaying:function(){return track;},stream:this.mapStream(stream,data.key,tracksArr)};}}catch(e){Trace.write(this.exceptionHdr+" processData():"+e.message,true);Trace.error(e);}
return null;},filterComposer:function(track,key){if(track!=null&&key.indexOf("classical")<0)
track.composer="";return track;},processFullData:function(data){try{Trace.write("processFullData:",this.debug);Trace.write(data,this.debug);if(data.key.indexOf('/metadata/full/')!=-1){var myObject=eval('('+data.value+')');var stream=myObject;var tracks=stream.tracks;var tracksArr=new Array();var len=tracks.length;var idx=0;for(var i=0;i<len;i++){var track=tracks[i];if(track["status"]=="0"||track["status"]=="1"||track["status"]=="2"){idx++;tracksArr.push(this.mapTrack(track));}}
return{rawData:data.value,key:data.key,stream:this.mapStream(stream,data.key,tracksArr)};}else{Trace.write("ERROR",true);Trace.write(data,true);}
return null;}catch(e){Trace.write(this.exceptionHdr+" processFullData():"+e.message,true);Trace.error(e);}},mapTrack:function(track){Trace.write("mapTrack(): track composerPermalink"+track["composerPermalink"],this.debug);Trace.write(track,this.debug);return{artist:track["artist"],infoLink:track["infolink"],composer:track["composer"],composerPermalink:track["composerPermalink"],iTunesLink:track["ituneslink"],permalink:track["permalink"],status:track["status"],thumbnail:track["thumbnail"],thumbnail_lrg:track["artwork400"],title:track["title"],type:track["type"]};},mapStream:function(stream,key,tracksArr){var arr=key.split("/");var postfixStream=(arr[3].indexOf('radio')!=-1)?"station":"genre";var permalink="/stream/"+postfixStream+"/"+arr[3]+"/"+arr[4];var category=stream["category"]||"none";var programinfolink=stream["permalink"];stream["permalink"]=permalink;return{name:stream["name"],category:category,programname:stream["programname"],programimage:stream["programimage"],programdescription:stream["programdescription"],programstarttime:stream["programstarttime"],programendtime:stream["programendtime"],programinfolink:programinfolink,mount:stream["stwmount"],roomid:key,permalink:stream["permalink"],tracks:tracksArr};}});

CBCR3.namespace("CBCR3.Modules");var _socketIO=null;var _nodeID=0;var options={'flash policy port':443};if(!_metadataServicesUrl)
var _metadataServicesUrl='';CBCR3.Modules.MetaNodeSocketProvider={getInstance:function(){try{if(typeof io=='undefined')
return null;if(_socketIO==null)
_socketIO=io.connect(_metadataServicesUrl,options);return _socketIO;}catch(e){Trace.write("io not defined",true);Trace.write(io,true);Trace.write(e,true);return null;}}};CBCR3.Modules.MetaNode=Class.create(CBCR3.Commons.EventDispatcher,{roomid:null,nodeID:"",initialize:function($super,roomid){try{$super();this.roomid=roomid;}catch(e){Trace.error(e);}}});
