/*
 * CBC Music Player
 * Copyright(c) 2008, CBC Music.
 */


Object.extend(String.prototype,{encodeQuotes:function()
{return this.replace(/"/g,"&quot;");}});

CBCR3.namespace("CBCR3.Player");CBCR3.Player.PlaylistItemType={personal:"personal",favourite:"favourite"};CBCR3.Player.TimeCount={down:"down",up:"up"};CBCR3.Player.PlayerMode={stream:"stream",playlist:"playlist",tango:"tango"};CBCR3.Player.ShuffleMode={shuffle:"shuffle",sequential:"sequential"};CBCR3.Player.PlayerStatus={playing:"playing",stopped:"stopped",inTransition:"inTransition"};CBCR3.Player.ThumbStatus={up:"up",down:"down",none:"none",disabled:"disabled"};CBCR3.Player.FavouriteStatus={clearToFavourite:"clearToFavourite",alreadyFavourited:"alreadyFavourited",disabled:"disabled"};CBCR3.Player.TrackType={track:"track",hostbreak:"hostbreak"};CBCR3.Player.StreamTrackStatus={playing:"playing",played:"played",scheduled:"scheduled"};

CBCR3.namespace("CBCR3.Player.Players");CBCR3.Player.Util={replaceClass:function(id,oldClass,newClass)
{$(id).removeClassName(oldClass);$(id).addClassName(newClass);},showLoading:function(element)
{var divId=element.id+"_loading";var loadingImage=new Element('div',{id:divId});loadingImage.addClassName("loading");element.appendChild(loadingImage);},hideLoading:function(element)
{var imageId=element.id+"_loading";if($(imageId))
$(imageId).remove();}};CBCR3.Player.Globals={playerId:"r3player",flashPlayerId:"flash",streamPlayerId:"quicktime",rtmpPlayerId:"rtmp",gatewayId:"flashGateway",meteorId:"meteorProxy",rtmpId:"rtmpGateway",adPlayerId:"adPlayer"};

CBCR3.namespace("CBCR3.Player.Events");CBCR3.Player.Events.StateInitEvent={r3PlayerInit:"stateInitEvent:r3PlayerInit",playlistPlayerLoaded:"stateInitEvent:playlistPlayerLoaded",streamPlayerLoaded:"stateInitEvent:streamPlayerLoaded",streamAudioOnlyLoaded:"stateInitEvent:streamAudioOnlyLoaded"};CBCR3.Player.Events.StreamEvent={connecting:"streamEvent:connecting",connected:"streamEvent:connected",metaData:"streamEvent:metaData",metaDataConnected:"streamEvent:metaDataConnected",metaDataStreamError:"streamEvent:metaDataStreamError",streamSelected:"streamEvent:streamSelected",adOverrideStart:"streamEvent:adOverrideStart",adOverrideStop:"streamEvent:adOverrideStop",blocked:"streamEvent:blocked",error:"streamEvent:error",logInfo:"streamEvent:logInfo"};CBCR3.Player.Events.StreamErrorEvent={notFound:"streamErrorEvent:notFound",failed:"streamErrorEvent:failed"};CBCR3.Player.Events.PlaybackEvent={start:"playbackEvent:start",pause:"playbackEvent:pause",progress:"playbackEvent:progress",finished:"playbackEvent:finished",stream:"playbackEvent:stream",next:"playbackEvent:next",prev:"playbackEvent:prev"};CBCR3.Player.Events.LoadingEvent={ready:"loadingEvent:ready",open:"loadingEvent:open",progress:"loadingEvent:progress",complete:"loadingEvent:complete",buffering:"loadingEvent:buffering"};CBCR3.Player.Events.ServiceEvent={success:"serviceEvent:success",personalPlaylistsReceived:"serviceEvent:personalPlaylistsReceived",favouritePlaylistsReceived:"serviceEvent:favouritePlaylistsReceived",trackReceived:"serviceEvent:trackReceived",playlistReceived:"serviceEvent:playlistReceived",permalinkContextReceived:"serviceEvent:permalinkContextReceived",metaDataUpdated:"serviceEvent:metaDataUpdated",permalinkChanged:"serviceEvent:permalinkChanged",adminPlaylistsReceived:"serviceEvent:adminPlaylistsReceived"};CBCR3.Player.Events.PlaylistEvent={playlistSelected:"playlistEvent:playlistSelected",deletePlaylist:"playlistEvent:deletePlaylist",permalinkSelected:"playlistEvent:permalinkSelected",permalinkAdded:"playlistEvent:permalinkAdded",trackSelected:"playlistEvent:trackSelected",createNewPlaylist:"playlistEvent:createNewPlaylist",savePlaylist:"playlistEvent:savePlaylist",addPlaylistSelected:"playlistEvent:addPlaylistSelected",newPlaylistCreated:"playlistEvent:newPlaylistCreated"};CBCR3.Player.Events.PlaybackCommand={play:"playbackCommand:play",stop:"playbackCommand:stop",pause:"playbackCommand:pause",playPause:"playbackCommand:playPause",kill:"playbackCommand:kill"};CBCR3.Player.Events.ScrubCommand={playhead:"scrubCommand:playhead",playheadPercent:"scrubCommand:playheadPercent",volume:"scrubCommand:volume"};CBCR3.Player.Events.ScrubEvent={changed:"scrubEvent:changed",slide:"scrubEvent:slide"};CBCR3.Player.Events.PlayerErrorEvent={streamError:"playerErrorEvent:streamError",trackNotFound:"playerErrorEvent:trackNotFound",ioError:"playerErrorEvent:ioError"};CBCR3.Player.Events.RTMPStreamEvent={ready:"rtmpStreamEvent:ready",connecting:"rtmpStreamEvent:connecting",connected:"rtmpStreamEvent:connected",stopped:"rtmpStreamEvent:stopped",progress:"rtmpStreamEvent:progress",start:"rtmpStreamEvent:start",streaming:"rtmpStreamEvent:streaming",buffering:"rtmpStreamEvent:buffering",blocked:"rtmpStreamEvent:blocked",metaDataConnected:"rtmpStreamEvent:metaDataConnected",metaDataConnectionFailed:"rtmpStreamEvent:metaDataConnectionFailed",metaDataReceived:"rtmpStreamEvent:metaDataReceived",adOverrideStart:"rtmpStreamEvent:adOverrideStart",adOverrideStop:"rtmpStreamEvent:adOverrideStop",streamAudioOnly:"rtmpStreamEvent:streamAudioOnly",failed:"rtmpStreamEvent:failed",logPlayEvent:"rtmpStreamEvent:logPlayEvent"};CBCR3.Player.Events.StreamCommand={load:"streamCommand:load",play:"streamCommand:play",stop:"streamCommand:stop",pause:"streamCommand:pause",kill:"streamCommand:kill",playPause:"streamCommand:playPause",loadAudioOnly:"streamCommand:loadAudioOnly",volume:"streamCommand:volume"};CBCR3.Player.Events.ModeControlEvent={stream:"modeControlEvent:stream",playlist:"modeControlEvent:playlist",browseTracks:"modeControlEvent:browseTracks",browseStreams:"modeControlEvent:browseStreams"};CBCR3.Player.Events.PermalinkEvent={trackAdded:"permalinkEvent:trackAdded",favouriteRemoved:"permalinkEvent:favouriteRemoved",favouriteAdded:"permalinkEvent:favouriteAdded",favouriteStatus:"permalinkEvent:favouriteStatus",confirm:"permalinkEvent:confirm",cancel:"permalinkEvent:cancel",sendPermalink:"permalinkEvent:sendPermalink",retrievePermalinkContext:"permalinkEvent:retrievePermalinkContext"};CBCR3.Player.Events.SelectorEvent={scheduleReceived:"selectorEvent:scheduleReceived"};CBCR3.Player.Events.ShuffleEvent={changed:"shuffleEvent:changed"};CBCR3.Player.Events.ThumbEvent={received:"thumbEvent:received",registered:"thumbEvent:registered",changed:"thumbEvent:changed"};CBCR3.Player.Events.PanelEvent={remove:"panelEvent:remove",click:"panelEvent:click"};CBCR3.Player.Events.TrackTimeEvent={changed:"trackTimeEvent:changed"};CBCR3.Player.Events.ServiceExceptionEvent={userNotAuthenticated:"serviceExceptionEvent:userNotAuthenticated",userOutsideCanada:"serviceExceptionEvent:userOutsideCanada",duplicateTrack:"serviceExceptionEvent:duplicateTrack",emptyPlaylist:"serviceExceptionEvent:emptyPlaylist",endOfPlaylist:"serviceExceptionEvent:endOfPlaylist",nullPlaylist:"serviceExceptionEvent:nullPlaylist"};CBCR3.Player.Events.PlaybackExceptionEvent={emptyPlaylist:"playbackExceptionEvent:emptyPlaylist",endOfPlaylist:"playbackExceptionEvent:endOfPlaylist",nullPlaylist:"playbackExceptionEvent:nullPlaylist"};CBCR3.Player.Events.AuthenticationEvent={loginRequired:"authenticationEvent:loginRequired"};CBCR3.Player.Events.PageEvent={playPermalink:"pageEvent:playPermalink",addPermalink:"pageEvent:addPermalink",favouritePermalink:"pageEvent:favouritePermalink",permalink:"pageEvent:permalink",playStream:"pageEvent:playStream",panelPlayStream:"pageEvent:panelPlayStream",gearsSelected:"pageEvent:gearsSelected",socialShare:"pageEvent:socialShare"};CBCR3.Player.Events.DisplayEvent={forceIERefresh:"displayEvent:forceIERefresh"};CBCR3.Player.Events.StatusEvent={notify:"statusEvent:notify"};CBCR3.Player.Events.StwCueEvent={adBreak:"break",endAdBreak:"endbreak"};CBCR3.Player.Events.Ads={adComplete:"ads:adComplete"};CBCR3.Player.Events.AutoplayStream={permalinkReceived:"autoplayStream:permalinkReceived"};CBCR3.Player.Events.VoteEvent={updateVoteButton:"voteEvent:updateVoteButton"};

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.Favourite=Class.create(CBCR3.Commons.EventDispatcher,{permalinkService:null,playlistPermalink:null,favouriteStatus:null,debug:false,initialize:function($super,permalinkService){$super();this.addButton=$('addFavourite');this.addButton.observe("click",this.favourite_Click.bind(this));this.permalinkService=permalinkService;this.permalinkService.addEventListener(CBCR3.Player.Events.PermalinkEvent.favouriteAdded,this.favouriteAddedHandler.bind(this));this.permalinkService.addEventListener(CBCR3.Player.Events.ServiceExceptionEvent.userNotAuthenticated,this.userNotAuthenticated.bind(this));},load:function(playlistPermalink,favouriteStatus){Trace.write("favourite.js -> load() playlistPermalink:"+playlistPermalink+" favouriteStatus:"+favouriteStatus,this.debug);this.playlistPermalink=playlistPermalink;this.favouriteStatus=favouriteStatus;if(favouriteStatus==CBCR3.Player.FavouriteStatus.clearToFavourite)
this.enable();else
this.disable();},enable:function(){this.addButton.removeAttribute("disabled");this.addButton.removeClassName('added');this.addButton.removeClassName('disabled');},disable:function(){this.addButton.setAttribute("disabled","disabled");this.addButton.addClassName('disabled');},favourite_Click:function(event){if(this.addButton.hasClassName('disabled'))
return;if(!CBCR3.environment().isLoggedIn){this.userNotAuthenticated({data:{message:"You must be logged in to like something."}});return;}
this.addPlaylistToFavourites(this.playlistPermalink);},addLike:function(permalink){this.permalinkService.addLike(permalink);},addPlaylistToFavourites:function(playlistPermalink){this.addLike(playlistPermalink);},favouriteAddedHandler:function(event){this.showAdded();this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.favouriteStatus,{favouriteStatus:CBCR3.Player.FavouriteStatus.disabled});this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.favouriteAdded,{playlistPermalink:this.playlistPermalink});},showAdded:function(event){},userNotAuthenticated:function(event){this.dispatchEvent(CBCR3.Player.Events.AuthenticationEvent.loginRequired,event.data);}});

CBCR3.namespace("CBCR3.Player.Exceptions");CBCR3.Player.Exceptions.Exception=Class.create({initialize:function()
{this.type="";this.message="";this.stackTrace="";this.statusCode="";this.timedOut="";}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.FavouritePlaylistItem=Class.create(CBCR3.Commons.EventDispatcher,{playlist:null,isActive:false,initialize:function($super,playlist)
{$super();this.playlist=playlist;},setIsActive:function(isActive)
{this.isActive=isActive;},attachTo:function(parent)
{var item=this.createPlaylistItem();parent.appendChild(item);return item;},createPlaylistItem:function()
{var playlistItem=new Element('div',{id:"favourite_"+this.playlist.id});playlistItem.addClassName('playlistItem');playlistItem.appendChild(this.createLabelButton());playlistItem.appendChild(this.createDeleteButton());return playlistItem;},createLabelButton:function()
{var button=new Element('button',{id:"favourite_label_"+this.playlist.id,type:"button",title:"Select this playlist"});button.addClassName("panelButton");button.addClassName("playlistItem_button");button.addClassName("favourite");button.appendChild(this.innerButton(this.playlist.title));Event.observe(button,'click',this.playlistItem_Click.bind(this));return button;},innerButton:function(text)
{var label=new Element("div");label.addClassName("playlistItem_label");if(this.isActive)
label.addClassName("active");label.innerHTML=text;return label;},createDeleteButton:function()
{var deleteButton=new Element('button',{id:"delete_"+this.playlist.id,type:"button",title:"Remove this playlist from your favourites"});deleteButton.addClassName("panelButton");deleteButton.addClassName("playlistItem_delete");deleteButton.innerHTML="Delete";var id='favourite_'+this.playlist.id;Event.observe(deleteButton,'click',this.playlistDelete_Click.bindAsEventListener(this,id));return deleteButton;},playlistDelete_Click:function(event,id)
{this.dispatchEvent(CBCR3.Player.Events.PlaylistEvent.deletePlaylist,{id:id,permalink:this.playlist.permalink});},playlistItem_Click:function(event){Trace.write("streampanel.js -> permalinkSelectedHandler()",true);Trace.write(event,true);this.dispatchEvent(CBCR3.Player.Events.PlaylistEvent.permalinkSelected,{permalink:this.playlist.permalink,playlistPermalink:this.playlist.playlistPermalink});}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.TrackItem=Class.create(CBCR3.Commons.EventDispatcher,{track:null,isActive:false,clientId:null,item:null,initialize:function($super,track)
{$super();this.track=track;},getElement:function()
{return this.item;},showActive:function()
{this.item.addClassName("trackItem_active");this.item.focus();},hideActive:function()
{this.item.removeClassName("trackItem_active");},create:function()
{this.item=new Element("button",{type:"button",title:"Select this track to play",className:"panelButton trackItem"});this.item.update(this.getTemplate().evaluate({artist:this.track.artist.escapeHTML(),title:this.track.title.escapeHTML(),sequence:this.track.sequence,toolTip:this.track.artist.escapeHTML()+" "+this.track.title.escapeHTML()}));this.item.observe('click',this.track_Click.bind(this));if((this.track.sequence%2)!=0)
this.item.addClassName("odd");return this.item;},track_Click:function(event)
{this.dispatchEvent(CBCR3.Player.Events.PlaylistEvent.trackSelected,{track:this.track});},getTemplate:function()
{var markup="<div class='trackItem_info'>"+"<label class='sequence'>#{sequence}</label>"+"<label class='track'>"+"<span class='artist'>#{artist}</span> "+"<span class='title'>#{title}</span>"+"</label>"+"</div>";return new Template(markup);}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.TrackTime=Class.create(CBCR3.Commons.EventDispatcher,{timeCount:CBCR3.Player.TimeCount.up,position:0,end:0,time:"0:00",initialize:function($super){$super();$('time').observe('click',this.time_Click.bind(this));var timeLabel=new Element('label',{id:'timeLabel'});$('time').appendChild(timeLabel);},time_Click:function(event){this.toggle();this.update(this.position,this.end);},toggle:function(){if(this.timeCount==CBCR3.Player.TimeCount.down)
this.timeCount=CBCR3.Player.TimeCount.up;else
this.timeCount=CBCR3.Player.TimeCount.down;this.dispatchEvent(CBCR3.Player.Events.TrackTimeEvent.changed,{timeCount:this.timeCount});},show:function(){$('time').setStyle({display:"block"});},hide:function(){$('time').setStyle({display:"none"});},getTimeCount:function(){return this.timeCount;},setTimeCount:function(timeCount){this.timeCount=timeCount;},update:function(position,end){this.position=position;this.end=end;var operator="";if(this.timeCount==CBCR3.Player.TimeCount.down){position=end-position;operator="-";}
if(position<end&&position>0)
$('timeLabel').innerHTML=operator+this.formatTime(position);},formatTime:function(ms){var secs=Math.floor(ms/1000);var minutes=Math.floor(secs/60);var seconds=Math.floor(secs%60);var hours="";if(seconds<10){seconds="0"+seconds;}
if(minutes>=60){hours=Math.floor(minutes/60);hours=hours+":";minutes=Math.floor(minutes%60);if(minutes<10){minutes="0"+minutes;}}
return hours+minutes+':'+seconds;}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.TrackPanelButton=Class.create(CBCR3.Commons.EventDispatcher,{panelButton:null,effect:null,initialize:function($super,buttonElement)
{$super();this.panelButton=buttonElement;this.panelButton.observe("click",this.tracks_Click.bind(this));},enableSlide:function()
{if(this.effect)
this.effect.cancel();this.effect=new Effect.Morph(this.panelButton,{style:"left:215px",duration:0.3,transition:Effect.Transitions.sinoidal});this.showEnabled();},enableStatic:function()
{this.panelButton.setStyle({left:"215px"});this.showEnabled();},showEnabled:function()
{this.panelButton.removeAttribute("disabled");this.panelButton.addClassName("enabled");this.panelButton.removeClassName("disabled");},disable:function()
{if(this.effect)
this.effect.cancel();this.effect=new Effect.Morph(this.panelButton,{style:"left:160px",duration:0.3,transition:Effect.Transitions.sinoidal});this.panelButton.setAttribute("disabled","disabled");this.panelButton.removeClassName("enabled");this.panelButton.addClassName("disabled");},tracks_Click:function(event)
{this.dispatchEvent(CBCR3.Player.Events.PanelEvent.click);}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.TrackPanel=Class.create(CBCR3.Commons.EventDispatcher,{modal:null,panel:null,trackItemPanel:null,playlistInfo:null,closeButton:null,musicService:null,playlistPermalink:null,sequence:0,trackItems:null,scrollTop:0,initialize:function($super,musicService)
{$super();this.musicService=musicService;this.musicService.addEventListener(CBCR3.Player.Events.ServiceEvent.playlistReceived,this.playlistReceivedHandler.bind(this));},update:function(newSequence)
{if(!this.isOpen())
return;if(this.sequence!=0)
this.trackItems[this.sequence].hideActive();this.sequence=newSequence;this.trackItems[this.sequence].showActive();},show:function(playlistPermalink,sequence)
{if(this.isOpen()){this.hide();return;}
this.playlistPermalink=playlistPermalink;this.sequence=sequence;this.showPanel();CBCR3.Player.Util.showLoading(this.trackItemPanel);this.retrievePlaylistTracks();},showPanel:function()
{if(!this.panel)
{this.panel=new Element('div',{id:'trackPanel'});$(document.body).insert(this.panel);Event.observe(window,"resize",this.windowResizeHandler.bind(this));}
this.panel.update(this.getPanelTemplate().evaluate({}));this.closeButton=this.panel.down(".trackPanel_close");this.closeButton.observe('click',this.trackPanelClose_Click.bind(this));this.trackItemPanel=this.panel.down(".trackPanel_trackItems");this.playlistInfo=this.panel.down(".trackPanel_playlistInfo");this.modal=new Control.Modal(this.panel,{overlayOpacity:0.75,className:'modalWindow',fade:false,position:[this.getXPos.bind(this),230]});this.modal.open();},getXPos:function()
{var viewport=(document.viewport.getWidth()>1000)?document.viewport.getWidth():1000;return viewport/2-this.panel.getWidth()/2+50;},windowResizeHandler:function(event)
{if(this.isOpen())
this.modal.position(event);},isOpen:function()
{return this.modal!=null&&this.modal.isOpen;},retrievePlaylistTracks:function()
{this.musicService.getPlaylist(this.playlistPermalink);},playlistReceivedHandler:function(event)
{var playlist=event.data.playlist;CBCR3.Player.Util.hideLoading(this.trackItemPanel);this.setHeaderItems(playlist);this.addTrackItems(playlist.tracks);},setHeaderItems:function(playlist)
{this.playlistInfo.update(this.getInfoTemplate().evaluate({title:playlist.title.truncate(37),toolTip:playlist.title,editUrl:playlist.permalink,permalink:playlist.permalink}));},addTrackItems:function(tracks)
{this.trackItems=new Array();for(var i=0;i<tracks.length;i++){this.addTrackItem(tracks[i]);}
this.setScrollPosition(this.scrollTop);},addTrackItem:function(track)
{var trackItem=new CBCR3.Player.Modules.TrackItem(track);trackItem.addEventListener(CBCR3.Player.Events.PlaylistEvent.trackSelected,this.trackSelectedHandler.bind(this));this.trackItemPanel.appendChild(trackItem.create());if(track.sequence==this.sequence){trackItem.showActive();this.scrollTop=this.calculateScrollPosition(trackItem.getElement(),track.sequence);}
this.trackItems[track.sequence]=trackItem;},calculateScrollPosition:function(element,sequence)
{return element.getHeight()*(sequence-1);},setScrollPosition:function(pos)
{this.trackItemPanel.scrollTop=pos;},trackSelectedHandler:function(event)
{this.update(event.data.track.sequence);this.dispatchEvent(CBCR3.Player.Events.PlaylistEvent.trackSelected,{track:event.data.track});},hide:function()
{this.modal.close();},trackPanelClose_Click:function(event)
{this.hide();},getPanelTemplate:function()
{return new Template("<div class='trackPanel_header'>"+"<button type='button' class='close trackPanel_close' title='Close track panel'>Close</button>"+"<div class='trackPanel_playlistInfo'></div>"+"</div>"+"<div class='trackPanel_trackItemsWrapper'>"+"<div class='trackPanel_trackItems'></div>"+"</div>"+"<div class='trackPanel_footer'></div>");},getInfoTemplate:function()
{return new Template("<label class='trackPanel_playlistTitle' title='#{toolTip}'>#{title}</label>"+"<div class='trackPanel_playlistLinks'>"+"<a class='r3playerLink' href='#{editUrl}' title='View playlist page'>VIEW</a> <span style='font-size:10px;'>|</span> "+"<a class='r3playerLink' href='#{permalink}' title='Right-click and copy this link to send playlist permalink to a friend'>PERMALINK</a>"+"</div>"+"<div class='clear'></div>");}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.TrackItem=Class.create(CBCR3.Commons.EventDispatcher,{track:null,isActive:false,clientId:null,item:null,initialize:function($super,track)
{$super();this.track=track;},getElement:function()
{return this.item;},showActive:function()
{this.item.addClassName("trackItem_active");this.item.focus();},hideActive:function()
{this.item.removeClassName("trackItem_active");},create:function()
{this.item=new Element("button",{type:"button",title:"Select this track to play",className:"panelButton trackItem"});this.item.update(this.getTemplate().evaluate({artist:this.track.artist.escapeHTML(),title:this.track.title.escapeHTML(),sequence:this.track.sequence,toolTip:this.track.artist.escapeHTML()+" "+this.track.title.escapeHTML()}));this.item.observe('click',this.track_Click.bind(this));if((this.track.sequence%2)!=0)
this.item.addClassName("odd");return this.item;},track_Click:function(event)
{this.dispatchEvent(CBCR3.Player.Events.PlaylistEvent.trackSelected,{track:this.track});},getTemplate:function()
{var markup="<div class='trackItem_info'>"+"<label class='sequence'>#{sequence}</label>"+"<label class='track'>"+"<span class='artist'>#{artist}</span> "+"<span class='title'>#{title}</span>"+"</label>"+"</div>";return new Template(markup);}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.CreateNewPlaylistItem=Class.create(CBCR3.Commons.EventDispatcher,{playlistService:null,item:null,button:null,createPlaylistInputBox:null,initialize:function($super){$super();this.playlistService=new CBCR3.Services.PlaylistService();this.playlistService.addEventListener(CBCR3.Player.Events.PlaylistEvent.newPlaylistCreated,this.newPlaylistCreatedHandler.bind(this));this.playlistService.addEventListener(CBCR3.Player.Events.ServiceExceptionEvent.userNotAuthenticated,this.userNotAuthenticatedHandler.bind(this));},create:function(){this.item=new Element("div",{className:"playlistItem"});this.item.update(this.getTemplate().evaluate({}));this.button=this.item.down("button");this.button.observe("click",this.createNewSelectedHandler.bind(this));return this.item;},createNewSelectedHandler:function(event){Trace.write("createNewSelectedHandler()",true);try{if(this.createPlaylistInputBox==null){this.createPlaylistInputBox=new CBCR3.Player.Modules.CreatePlaylistInputBox();this.createPlaylistInputBox.addEventListener(CBCR3.Player.Events.PlaylistEvent.savePlaylist,this.onSavePlaylist.bind(this));this.item.insert({after:this.createPlaylistInputBox.create()});}
else
this.createPlaylistInputBox.show();this.createPlaylistInputBox.focus();}catch(e){Trace.error(e);}},onSavePlaylist:function(event){this.playlistService.createNewPlaylist(event.data.playlistName);},newPlaylistCreatedHandler:function(event){Trace.write("newPlaylistCreatedHandler()",true);this.dispatchEvent(CBCR3.Player.Events.PlaylistEvent.newPlaylistCreated,{playlistPermalink:event.data.playlistPermalink});},userNotAuthenticatedHandler:function(event){this.dispatchEvent(event.type,event.data);},getTemplate:function(){var markup="<button type=\"button\" class=\"createPlaylistBtn panelButton full\" title=\"Create and name new playlist\">"+"<img src=\"/lib/cbcmusic/images/modal/subhdr_create_playlist.png\">"+"</button>";return new Template(markup);}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.CreatePlaylistInputBox=Class.create(CBCR3.Commons.EventDispatcher,{inputPanel:null,saveButton:null,cancelButton:null,playlistNameInput:null,initialize:function($super){Trace.write("CreatePlaylistInputBox -> Initialize()",true);$super();},create:function(){this.inputPanel=new Element("div",{className:"createPlaylistInputBox"});this.inputPanel.setStyle({display:"block"});this.inputPanel.update(this.getTemplate().evaluate({}));this.saveButton=this.inputPanel.down(".createPlaylistInputBox_save");this.saveButton.observe("click",this.saveButton_Click.bind(this));this.cancelButton=this.inputPanel.down(".createPlaylistInputBox_cancel");this.cancelButton.observe("click",this.cancelButton_Click.bind(this));this.playlistNameInput=this.inputPanel.down("input");this.playlistNameInput.observe("keypress",this.playlistNameInputHandler.bind(this));return this.inputPanel;},focus:function(){this.playlistNameInput.focus();},saveButton_Click:function(event){this.save();},playlistNameInputHandler:function(event){if(event.keyCode==13){Event.stop(event);this.save();}},save:function(){this.dispatchEvent(CBCR3.Player.Events.PlaylistEvent.savePlaylist,{playlistName:this.playlistNameInput.getValue()});},cancelButton_Click:function(event){this.hide();},hide:function(){this.inputPanel.hide();},show:function(){this.inputPanel.show();},getTemplate:function(){var markup="<div class=\"createPlaylistInputBox_playlistName\">"+"<input type=\"text\" title=\"Enter the name of your new playlist here\" />"+"</div>"+"<div class=\"confirmPanel\">"+"<div class=\"userMessage\">"+"Give your new playlist a name and Hit SAVE to create a new playlist"+"</div>"+"<div class=\"buttons\">"+"<button type=\"button\" class=\"createPlaylistInputBox_button createPlaylistInputBox_save\" title=\"Create a new playlist.\">SAVE</button>"+"<button type=\"button\" class=\"createPlaylistInputBox_button createPlaylistInputBox_cancel\" title=\"Cancel creation of new playlist\">CANCEL</button>"+"</div>"+"</div>";return new Template(markup);},isVisible:function(){if(this.inputPanel==null)
return false;if(this.inputPanel.getStyle("display")=="block")
return true;return false;}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.TrackExistsChooser=Class.create(CBCR3.Commons.EventDispatcher,{instanceId:null,parentElement:null,panel:null,addButton:null,cancelButton:null,initialize:function()
{},attachTo:function(parentElement)
{this.parentElement=parentElement;if($(this.getInstanceId())==null)
this.create();},getInstanceId:function()
{return this.parentElement.id+"_trackExists";},create:function()
{if(this.panel!=null)
return;this.parentElement.insert({after:this.createPanel()});this.focus();},createPanel:function()
{this.panel=new Element("div",{id:this.getInstanceId(),className:"trackExistsChooser"});this.panel.update(this.getInnerTemplate().evaluate({}));this.addButton=this.panel.down(".trackExistsChooser_add");this.addButton.observe("click",this.addTrack_Click.bind(this));this.cancelButton=this.panel.down(".trackExistsChooser_cancel");this.cancelButton.observe("click",this.cancel_Click.bind(this));return this.panel;},focus:function()
{this.addButton.focus();},addTrack_Click:function(event)
{this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.confirm);},cancel_Click:function(event)
{this.cancel();},cancel:function()
{this.destroy();this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.cancel);},destroy:function()
{$(this.getInstanceId()).remove();this.panel==null;},getInnerTemplate:function()
{var markup="<div class=\"confirmPanel\">"+"<div class=\"userMessage\">"+"This playlist already contains the song you're adding."+"</div>"+"<div class=\"buttons\">"+"<button type='button' class='trackExistsChooser_button trackExistsChooser_add' title='Add this track to this playlist again'>Add</button>"+"<button type='button' class='trackExistsChooser_button trackExistsChooser_cancel'>Cancel</button>"+"</div>"+"</div>";return new Template(markup);}});

CBCR3.namespace("CBCR3.Player.Models");CBCR3.Player.Models.Track=Class.create({initialize:function(properties)
{if(!properties)
properties={};this.title=properties.title||"";this.artist=properties.artist||"";this.infoLink=properties.infoLink||"";this.permalink=properties.permalink||"";this.type=properties.type||"";this.iTunesLink=properties.iTunesLink||"";}});

CBCR3.namespace("CBCR3.Player.Models");CBCR3.Player.Models.PlaylistTrack=Class.create(CBCR3.Player.Models.Track,{initialize:function($super,properties)
{$super(properties);if(!properties)
properties={};this.artistPermalink=properties.artistPermalink,this.duration=properties.duration||0;this.audioUrl=properties.audioUrl||"";this.sequence=properties.sequence||"";this.isGeoFenced=properties.isGeoFenced||false;this.isType=properties.isType||"none";this.pollId=properties.pollId;this.pollQuestionId=properties.pollQuestionId;this.pollQuestionItemId=properties.pollQuestionItemId;this.shouldPlayInSequenceMode=properties.shouldPlayInSequenceMode||false;this.thumb=properties.thumb||CBCR3.Player.ThumbStatus.none;this.thumbnail=properties.thumbnail||CBCR3.Player.ThumbStatus.none;this.thumbnail3x4=properties.thumbnail3x4||CBCR3.Player.ThumbStatus.none;this.shortTitle=properties.shortTitle||"";this.trackId=properties.trackId||"";this.uniqueHash=properties.uniqueHash||"";}});

CBCR3.namespace("CBCR3.Player.Services");CBCR3.Player.Services.ThumbWebLookupService=Class.create(CBCR3.Commons.EventDispatcher,{permalink:"",initialize:function($super)
{$super();},getThumbStatus:function(permalink)
{CBC.Radio3.Player.Web.PlayerWebService.GetThumbStatus(permalink,this.getThumbStatus_Success.bind(this),this.getThumbStatus_Failed.bind(this));},parseThumbStatus:function(dto)
{return dto;},getThumbStatus_Success:function(response)
{var thumbStatus=this.parseThumbStatus(response);this.dispatchEvent(CBCR3.Player.Events.ThumbEvent.received,{thumbStatus:thumbStatus});},getThumbStatus_Failed:function(errorResponse)
{var exception=new CBCR3.Player.Exceptions.SoapExceptionFactory().createException(errorResponse);var type=new CBCR3.Player.Exceptions.SoapExceptionLookup().map(exception.type);this.dispatchEvent(type,{exception:exception});}});

Control.Slider.addMethods({setStaticValue:function(sliderValue,handleIdx)
{if(!this.active){this.activeHandleIdx=handleIdx||0;this.activeHandle=this.handles[this.activeHandleIdx];this.updateStyles();}
handleIdx=handleIdx||this.activeHandleIdx||0;if(this.initialized&&this.restricted){if((handleIdx>0)&&(sliderValue<this.values[handleIdx-1]))
sliderValue=this.values[handleIdx-1];if((handleIdx<(this.handles.length-1))&&(sliderValue>this.values[handleIdx+1]))
sliderValue=this.values[handleIdx+1];}
sliderValue=this.getNearestValue(sliderValue);this.values[handleIdx]=sliderValue;this.value=this.values[0];this.handles[handleIdx].style[this.isVertical()?'top':'left']=this.translateToPx(sliderValue);this.drawSpans();}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.PrevNext=Class.create(CBCR3.Commons.EventDispatcher,{mode:null,historyPanel:null,upcomingPanel:null,prevButton:null,nextButton:null,searchlightNextButton:null,streamCollection:null,activePermalink:null,metaDataNotifier:null,initialize:function($super,metaDataNotifier){$super();this.prevButton=$("prev");this.prevButton.observe('click',this.prev_Click.bind(this));this.nextButton=$("next");this.nextButton.observe('click',this.next_Click.bind(this));var self=this;$(document).on("click",".searchlightNextButton",function(event){Event.stop(event);self.nextsearchlight_Click(this);});this.metaDataNotifier=metaDataNotifier;this.metaDataNotifier.addEventListener(CBCR3.Player.Events.ServiceEvent.metaDataUpdated,this.metaDataUpdatedHandler.bind(this));this.metaDataNotifier.addEventListener(CBCR3.Player.Events.ServiceEvent.permalinkChanged,this.permalinkChangedHandler.bind(this));},metaDataUpdatedHandler:function(event){this.streamCollection=event.data.metaData;this.update();},permalinkChangedHandler:function(event){this.activePermalink=event.data.permalink;},currentStream:function(){return this.streamCollection.get(this.activePermalink);},update:function(){if(this.historyPanel)
this.historyPanel.load(this.currentStream().getPlayedTracks());if(this.upcomingPanel)
this.upcomingPanel.load(this.currentStream().getScheduledTracks());},prev_Click:function(event){if(this.mode==CBCR3.Player.PlayerMode.playlist){this.dispatchEvent(CBCR3.Player.Events.PlaybackEvent.prev);}
else{this.showHistory(event);}},showHistory:function(event){if(this.historyPanel!=null&&this.historyPanel.isOpen()){this.historyPanel.hide();return;}
var cumOff=event.element().cumulativeOffset();var settings={headerClass:"history",showScheduleTime:true,xPos:cumOff[0],yPos:cumOff[1],buttonClass:"schedulePanel_prev"};this.historyPanel=this.createPanel(settings);this.historyPanel.create();this.historyPanel.load(this.currentStream().getPlayedTracks());},next_Click:function(event){if(this.mode==CBCR3.Player.PlayerMode.playlist){this.dispatchEvent(CBCR3.Player.Events.PlaybackEvent.next);}
else if(this.mode==CBCR3.Player.PlayerMode.tango){this.dispatchEvent(CBCR3.Player.Events.PlaybackEvent.next);}
else{this.showUpcoming(event);}},nextsearchlight_Click:function(event){this.dispatchEvent(CBCR3.Player.Events.PlaybackEvent.next);},showUpcoming:function(event){if(this.upcomingPanel!=null&&this.upcomingPanel.isOpen()){this.upcomingPanel.hide();return;}
var cumOff=event.element().cumulativeOffset();var settings={headerClass:"upcoming",showScheduleTime:true,xPos:cumOff[0],yPos:cumOff[1],buttonClass:"schedulePanel_next"};this.upcomingPanel=this.createPanel(settings);this.upcomingPanel.create();this.upcomingPanel.load(this.currentStream().getScheduledTracks());},createPanel:function(settings){var panel=new CBCR3.Player.Modules.SchedulePanel(settings);panel.addEventListener(CBCR3.Player.Events.PlaylistEvent.permalinkSelected,this.permalinkSelectedHandler.bind(this));panel.addEventListener(CBCR3.Player.Events.PlaylistEvent.permalinkAdded,this.permalinkAddedHandler.bind(this));return panel;},permalinkSelectedHandler:function(event){this.dispatchEvent(CBCR3.Player.Events.PlaylistEvent.permalinkSelected,{permalink:event.data.permalink});},permalinkAddedHandler:function(event){this.dispatchEvent(CBCR3.Player.Events.PlaylistEvent.permalinkAdded,{permalink:event.data.permalink});},setStreamMode:function(){this.mode=CBCR3.Player.PlayerMode.stream;CBCR3.Player.Util.replaceClass('prev','prevPlaylist','prevStream');CBCR3.Player.Util.replaceClass('next','nextPlaylist','nextStream');},setPlaylistMode:function(){this.mode=CBCR3.Player.PlayerMode.playlist;CBCR3.Player.Util.replaceClass('prev','prevStream','prevPlaylist');CBCR3.Player.Util.replaceClass('next','nextStream','nextPlaylist');},setTangoMode:function(){this.mode=CBCR3.Player.PlayerMode.tango;CBCR3.Player.Util.replaceClass('prev','prevStream','prevPlaylist');CBCR3.Player.Util.replaceClass('next','nextStream','nextPlaylist');},disable:function(){this.prevButton.setAttribute("disabled","disabled");this.prevButton.addClassName("disabled");this.nextButton.setAttribute("disabled","disabled");this.nextButton.addClassName("disabled");},enable:function(){this.prevButton.removeAttribute("disabled");this.prevButton.removeClassName("disabled");this.nextButton.removeAttribute("disabled");this.nextButton.removeClassName("disabled");}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.PersonalPlaylistItem=Class.create(CBCR3.Commons.EventDispatcher,{playlist:null,isActive:false,showViewButton:true,initialize:function($super,playlist){$super();this.playlist=playlist;},setIsActive:function(isActive){this.isActive=isActive;},getInstanceId:function(){Trace.write("personalplaylistitem.js -> getInstanceId()",true);Trace.write(this,true);return"personal_"+this.playlist.id;},setShowViewButton:function(showViewButton){this.showViewButton=showViewButton;},attachTo:function(parent){var item=this.createPlaylistItem(this.playlist);parent.appendChild(item);return item;},createPlaylistItem:function(playlist){var playlistItem=new Element('div',{id:"personal_"+this.playlist.id});playlistItem.addClassName('playlistItem');playlistItem.appendChild(this.createLabelButton());if(this.showViewButton)
playlistItem.appendChild(this.createEditButton());return playlistItem;},createLabelButton:function(){var button=new Element('button',{id:"personal_label_"+this.playlist.id,type:"button",title:"Select this playlist"});button.addClassName("panelButton");button.addClassName("playlistItem_button");button.addClassName("personal");if(!this.showViewButton)
button.addClassName("full");button.appendChild(this.innerButton(this.playlist.title));button.observe('click',this.playlistItem_Click.bindAsEventListener(this,this.getInstanceId()));return button;},innerButton:function(text){var label=new Element("div");label.addClassName("playlistItem_label");if(this.isActive)
label.addClassName("active");label.innerHTML=text.escapeHTML();return label;},createEditButton:function(){var link=new Element('a',{title:"Go to the playlist edit page",href:this.playlist.permalink});link.addClassName("panelButton");link.addClassName("playlistItem_edit");link.update("Edit Playlist");return link;},playlistItem_Click:function(event,id){Trace.write("playlistItem_Click() personalplaylistitem.js -> ",true);Trace.write(this,true);this.dispatchEvent(CBCR3.Player.Events.PlaylistEvent.permalinkSelected,{id:id,permalink:this.playlist.permalink,playlistPermalink:this.playlist.playlistPermalink});}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.PlaylistTrackAdder=Class.create(CBCR3.Commons.EventDispatcher,{permalinkService:null,parentElement:null,trackExistsChooser:null,trackPermalink:null,playlistPermalink:null,initialize:function($super,permalinkService,trackPermalink,playlistPermalink)
{$super();this.trackPermalink=trackPermalink;this.playlistPermalink=playlistPermalink;this.permalinkService=permalinkService;this.permalinkService.addEventListener(CBCR3.Player.Events.PermalinkEvent.trackAdded,this.trackAddedHandler.bind(this));this.permalinkService.addEventListener(CBCR3.Player.Events.ServiceExceptionEvent.duplicateTrack,this.duplicateTrackHandler.bind(this));this.permalinkService.addEventListener(CBCR3.Player.Events.ServiceExceptionEvent.userNotAuthenticated,this.userNotAuthenticatedHandler.bind(this));this.trackExistsChooser=new CBCR3.Player.Modules.TrackExistsChooser();this.trackExistsChooser.addEventListener(CBCR3.Player.Events.PermalinkEvent.confirm,this.permalinkConfirmHandler.bind(this));this.trackExistsChooser.addEventListener(CBCR3.Player.Events.PermalinkEvent.cancel,this.permalinkCancelHandler.bind(this));},addTrackToPlaylist:function()
{this.permalinkService.addTrackToPlaylist(this.trackPermalink,this.playlistPermalink,false);},attachTo:function(parentElement)
{this.parentElement=parentElement;},trackAddedHandler:function(event)
{this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.trackAdded,event.data);},duplicateTrackHandler:function(event)
{this.trackExistsChooser.attachTo(this.parentElement);this.dispatchEvent(CBCR3.Player.Events.DisplayEvent.forceIERefresh,null);},permalinkConfirmHandler:function(event)
{this.permalinkService.addTrackToPlaylist(this.trackPermalink,this.playlistPermalink,true);},permalinkCancelHandler:function(event)
{this.dispatchEvent(CBCR3.Player.Events.DisplayEvent.forceIERefresh,null);},userNotAuthenticatedHandler:function(event)
{this.dispatchEvent(event.type,event.data);}});

CBCR3.namespace("CBCR3.Player.Models");CBCR3.Player.Models.Playlist=Class.create({initialize:function(properties){if(!properties)
properties={};this.id=properties.id||0;this.title=properties.title||"";this.permalink=properties.permalink||"";this.playlistPermalink=properties.playlistPermalink||"";this.sequenceId=properties.sequenceId||0;this.tracks=properties.tracks||{};this.infoLink=properties.infoLink||"";this.lastmodified=properties.lastmodified||"";this.trackcount=properties.trackcount||"0";}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.VolumeScrubber=Class.create(CBCR3.Commons.EventDispatcher,{volume:50,trackWidth:null,trackHandleWidth:null,volumeHandle:null,volumeSlider:null,volumeFill:null,volumeSpan:null,currentVolume:null,initialize:function($super,initialVolume){$super();this.initialVolume=initialVolume;this.volumeHandle=$('volumeHandle');this.volumeTrack=$('volumeTrack');this.volumeSpan=$('volumeSpan');this.load();},load:function(){this.trackWidth=this.volumeTrack.getWidth();this.trackHandleWidth=this.volumeHandle.getWidth();this.volumeSlider=new Control.Slider
(this.volumeHandle,this.volumeTrack,{range:$R(0,92),sliderValue:this.initialVolume,startSpan:this.volumeSpan,onSlide:this.setBgPos.bind(this),onChange:this.setBgPos.bind(this),alignX:0,alignY:-4});this.setBgPos(this.initialVolume);$('volumeLess').observe("click",this.setMinimum.bindAsEventListener(this));$('volumeMore').observe("click",this.setMaximum.bindAsEventListener(this));},setMinimum:function(){this.setBgPos(this.volumeSlider.minimum);},setMaximum:function(){this.setBgPos(this.volumeSlider.maximum);},setBgPos:function(value){this.setTitle(value);this.currentVolume=value;var adjustedWidth=(value>=this.volumeSlider.maximum)?(value/this.trackWidth*this.trackHandleWidth):this.trackHandleWidth/2;this.volumeSpan.setStyle({width:(this.adjustValueToWidth(value)+adjustedWidth)+'px'});this.volumeHandle.setStyle({left:this.adjustValueToWidth(value)+'px'});this.dispatchEvent(CBCR3.Player.Events.ScrubEvent.changed,{percent:value});},adjustValueToWidth:function(value){return Math.round(value)/100*this.trackWidth;},setTitle:function(value){this.volumeHandle.title=new Template("Volume #{volume}% (Drag to adjust <>)").evaluate({volume:Math.floor(value)});}});

CBCR3.namespace("CBCR3.Player.Modules");var _playerInfoTimeout;CBCR3.Player.Modules.TrackDisplay=Class.create(CBCR3.Commons.EventDispatcher,{container:null,info:null,infoContainer:null,contextContainer:null,title:null,subTitle:null,nowPlayingToggle:null,iTunesButton:null,timeoutMilliSeconds:3000,debug:false,setAlready:false,updateStarted:false,moveEffect:null,trackInfoOffset:false,adActive:false,MAX_TITLE_LENGTH:45,initialize:function($super){$super();this.container=$("trackDisplay");this.info=this.container.down("#info");this.info.observe("mouseover",this.trackInfoHandler_hover.bind(this));this.infoContainer=this.container.down(".infoContainer");this.title=this.container.down(".title");this.subTitle=this.container.down(".subTitle");this.nowPlayingToggle=$("nowPlaying");this.nowPlayingToggle.observe("click",this.nowPlayingToggle_Click.bind(this));this.iTunesButton=$("buy");this.iTunesButton.observe("click",this.iTunesButton_Click.bind(this));},setAdActive:function(value){this.adActive=value;},iTunesButton_Click:function(event){if(this.iTunesButton.hasClassName('disabled'))
return;},nowPlayingToggle_Click:function(event){this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.retrievePermalinkContext,{});},enableNowPlaying:function(){this.nowPlayingToggle.removeAttribute("disabled");this.nowPlayingToggle.removeClassName("disabled");},clear:function(){this.setDisplay("","","");},setDisplay:function(titleText,subTitleText,infoLink,iTunesLink,type,showcomposer,composerText,composerPermalink){try{Trace.write("trackdisplay.js showcomposer:"+showcomposer,true);this.updateStarted=true;this.resetInfoScrolling();this.resetScroll();if(showcomposer&&composerText){if(composerPermalink)
subTitleText="<a href=\""+composerPermalink+"\">"+composerText+":</a>"+subTitleText;else
subTitleText="<span>"+composerText+":</span>&nbsp;"+subTitleText;}
this.subTitle.update(subTitleText);this.subTitle.setAttribute('title',subTitleText);this.setiTunesButton(iTunesLink);if(!infoLink||infoLink.blank()){this.title.update(titleText);}else{this.title.update();var titleHref=new Element('a',{href:infoLink,title:titleText,className:"r3playerLink"});titleHref.update(titleText);titleHref.observe("click",this.onTitle_Click.bind(this));this.title.update(titleHref);}
if(!this.adActive)
this.startTextScroll(5000);}catch(e){Trace.error(e);}},trackInfoHandler_hover:function(){if(!this.trackSlideStarted&&!this.adActive){this.resetInfoScrolling();this.startTextScroll(2000);}},resetInfoScrolling:function(){if(this.moveEffect!=null)this.moveEffect.cancel();window.clearTimeout(_playerInfoTimeout);this.infoContainer.setStyle({left:"0px"});this.trackSlideStarted=false;},startTextScroll:function(delay){var contWidth=this.infoContainer.getWidth();var infoWidth=this.info.getWidth();this.updateStarted=false;if(contWidth>infoWidth)
this.setDelay((contWidth-infoWidth)*-1,delay);else
this.infoContainer.setStyle({left:"0px"});},setInfoScroll:function(moveBy){if(this.updateStarted){this.moveEffect.cancel();return;}
var durationSeconds=0.5;var absMoveBy=Math.abs(moveBy);if(absMoveBy>42)
durationSeconds=absMoveBy/85;var self=this;this.moveEffect=new Effect.Move(this.infoContainer,{x:moveBy,transition:Effect.Transitions.sinoidal,duration:durationSeconds,afterFinish:self.setDelay.bind(self,moveBy*-1,5000)});},setDelay:function(moveBy,delay){if(moveBy<0&&this.trackSlideStarted){this.resetInfoScrolling();}else{this.trackSlideStarted=true;_playerInfoTimeout=window.setTimeout(this.setInfoScroll.bind(this,moveBy),delay);}},onTitle_Click:function(event){},setContextData:function(permalinkContext){if(this.contextContainer==null)
this.appendContextContainer();this.contextContainer.update(permalinkContext.render());this.scrollUp();this.scrollDown.bind(this).delay(3.5);},appendContextContainer:function(){this.contextContainer=new Element("div",{className:"context"});this.info.appendChild(this.contextContainer);},scrollUp:function(){new Effect.Morph(this.title,{style:"margin-top:-30px",duration:0.5});},scrollDown:function(){new Effect.Morph(this.title,{style:"margin-top:0px",duration:0.5});},resetScroll:function(){this.title.setStyle({marginTop:"0px"});},setiTunesButton:function(iTunesLink){this.iTunesButton.href=iTunesLink;this.iTunesButton.title="Buy this track on iTunes";this.iTunesButton.update(this.iTunesButton.title);iTunesLink==null||iTunesLink.blank()?this.disableiTunesButton():this.enableiTunesButton();},disableiTunesButton:function(){this.iTunesButton.addClassName('disabled');this.iTunesButton.setAttribute("disabled","disabled");this.iTunesButton.removeAttribute("href");this.iTunesButton.removeAttribute("title");},enableiTunesButton:function(){this.iTunesButton.removeClassName('disabled');this.iTunesButton.removeAttribute("disabled");}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.ProgressScrubber=Class.create(CBCR3.Commons.EventDispatcher,{progressSlider:null,progressTrack:null,stationInfo:null,isScrubbing:false,progressFill:null,progressHandle:null,progressDisplay:null,trackBuffer:5,handleWidth:5,debug:false,initialize:function($super){$super();this.load();this.disable();},load:function(){this.progressTrack=$('progressTrack');this.stationInfo=$('stationInfo');this.progressFill=$('progressFill');this.progressHandle=$('progressHandle');this.handleWidth=this.progressHandle.getWidth();this.progressDisplay=$('progressDisplay');this.progressSlider=new Control.Slider
(this.progressHandle,this.progressTrack,{range:$R(0,325),onSlide:this.progressSlideHandler.bind(this),onChange:this.progressChangeHandler.bind(this)});this.progressDisplay.observe('click',this.seekPlayLocation.bindAsEventListener(this));this.progressFill.observe('click',this.seekPlayLocation.bindAsEventListener(this));},seekPlayLocation:function(event){var xpos=Event.pointerX(event);var leftpos=this.progressDisplay.cumulativeOffset()[0];var end=this.progressDisplay.getWidth();this.progressChangeHandler(xpos-leftpos);},progressSlideHandler:function(value){this.updateFill();this.isScrubbing=true;},progressChangeHandler:function(value){this.isScrubbing=false;var maxLoaded=this.progressDisplay.getWidth();if(value>maxLoaded)
return;this.progressSlider.setStaticValue(value,0);this.updateFill();var percent=value/maxLoaded;this.dispatchEvent(CBCR3.Player.Events.ScrubEvent.changed,{percent:percent});},updatePosition:function(position,end){if(this.isScrubbing)
return;var _width=this.progressDisplay.getWidth();var progressHandlePosition=(position/end)*_width;this.progressSlider.setStaticValue(progressHandlePosition,0);this.updateFill();},updateFill:function(){var fillPosition=this.progressHandle.getStyle("left").replace("px","");fillPosition=Math.round(fillPosition);this.progressFill.setStyle({width:(fillPosition)+"px"});},updatePercentLoaded:function(percentLoaded){var loaded=Math.round((percentLoaded/100)*325);this.progressDisplay.setStyle({width:loaded+"px"});},reset:function(){this.progressSlider.setStaticValue(0,0);this.progressHandle.setStyle("left","0px");this.stationInfo.update();this.updateFill();this.progressDisplay.setStyle({display:"block",width:"0px"});this.removeStreamInfo();},enable:function(){this.progressHandle.setStyle({display:"block"});this.progressDisplay.setStyle({display:"block"});this.progressSlider.setEnabled();},disable:function(){this.progressHandle.setStyle({display:"none"});this.progressDisplay.setStyle({display:"none"});this.progressSlider.setDisabled();},displayBuffering:function(){this.progressTrack.addClassName("buffering");},hideBuffering:function(){this.progressTrack.removeClassName("buffering");},displayStreamInfo:function(stationText){this.progressTrack.hide();this.stationInfo.update("Current Station:&nbsp;<span>"+stationText+"</span>");this.stationInfo.insert(new Element("div",{className:'hr'}));this.stationInfo.show();},removeStreamInfo:function(){try{Trace.write("removeStreamInfo() - progressscrubber.js() ",this.debug);this.progressTrack.show();this.stationInfo.hide();}catch(e){Trace.error(e);}}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.PlayPause=Class.create(CBCR3.Commons.EventDispatcher,{isPlaying:false,playPauseButton:null,initialize:function($super,isPlaying)
{$super();this.playPauseButton=$("playPause");this.playPauseButton.observe('click',this.playPause_Click.bind(this));this.setIsPlaying(isPlaying);},setIsPlaying:function(isPlaying)
{this.isPlaying=isPlaying;this.load();},load:function()
{if(this.isPlaying)
this.showPause();else
this.showPlay();},showPlay:function()
{CBCR3.Player.Util.replaceClass(this.playPauseButton,'pause','play');},showPause:function()
{CBCR3.Player.Util.replaceClass(this.playPauseButton,'play','pause');},playPause_Click:function(event)
{this.update();},update:function()
{if(this.isPlaying)
{this.setIsPlaying(false);this.dispatchEvent(CBCR3.Player.Events.PlaybackCommand.pause);}
else
{this.setIsPlaying(true);this.dispatchEvent(CBCR3.Player.Events.PlaybackCommand.play);}},disable:function(){this.playPauseButton.setAttribute("disabled","disabled");this.playPauseButton.addClassName("disabled");},enable:function()
{this.playPauseButton.removeAttribute("disabled");this.playPauseButton.removeClassName("disabled");}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.ModeControls=Class.create(CBCR3.Commons.EventDispatcher,{trackPanelButton:null,streamButton:null,playlistButton:null,browseTracksButton:null,initialize:function($super)
{$super();this.browseTracksButton=new CBCR3.Player.Modules.TrackPanelButton($("tracks"));this.browseTracksButton.addEventListener(CBCR3.Player.Events.PanelEvent.click,this.browseTracksClickHandler.bind(this));this.streamButton=$("stream");this.streamButton.observe('click',this.stream_Click.bind(this));this.playlistButton=$("playlist");this.playlistButton.observe('click',this.playlist_Click.bind(this));},stream_Click:function(event)
{this.dispatchEvent(CBCR3.Player.Events.ModeControlEvent.browseStreams);},playlist_Click:function(event)
{this.dispatchEvent(CBCR3.Player.Events.ModeControlEvent.playlist);},streamMode:function()
{this.streamButton.removeClassName('off');this.playlistButton.addClassName("off");this.browseTracksButton.disable();},playlistMode:function(isResume)
{this.playlistButton.removeClassName('off');this.streamButton.addClassName("off");isResume?this.browseTracksButton.enableStatic():this.browseTracksButton.enableSlide()},browseTracksClickHandler:function(event)
{this.dispatchEvent(CBCR3.Player.Events.ModeControlEvent.browseTracks);},disableTrackPanel:function()
{this.browseTracksButton.disable();},enableStreamPanel:function()
{}});

CBCR3.namespace("CBCR3.Player.Exceptions");CBCR3.Player.Exceptions.SoapExceptionFactory=Class.create({initialize:function()
{},createException:function(soapException)
{var exception=new CBCR3.Player.Exceptions.Exception();exception.type=soapException.get_exceptionType();exception.message=soapException.get_message();exception.stackTrace=soapException.get_stackTrace();exception.timedOut=soapException.get_timedOut();exception.statusCode=soapException.get_statusCode();return exception;}});

CBCR3.namespace("CBCR3.Player.Exceptions");CBCR3.Player.Exceptions.SoapExceptionLookup=Class.create({exceptionMap:null,initialize:function()
{this.populateMap();},populateMap:function()
{this.exceptionMap=new Hash();this.exceptionMap.set("CBC.Radio3.Player.Exceptions.UserNotAuthenticatedException",CBCR3.Player.Events.ServiceExceptionEvent.userNotAuthenticated);this.exceptionMap.set("CBC.Radio3.Player.Exceptions.DuplicateTrackException",CBCR3.Player.Events.ServiceExceptionEvent.duplicateTrack);this.exceptionMap.set("CBC.Radio3.Player.Exceptions.EmptyPlaylistException",CBCR3.Player.Events.ServiceExceptionEvent.emptyPlaylist);this.exceptionMap.set("CBC.Radio3.Player.Exceptions.EndOfPlaylistException",CBCR3.Player.Events.ServiceExceptionEvent.endOfPlaylist);this.exceptionMap.set("CBC.Radio3.Player.Exceptions.NullPlaylistException",CBCR3.Player.Events.ServiceExceptionEvent.nullPlaylist);},map:function(soapExceptionType)
{var exceptionType=this.exceptionMap.get(soapExceptionType);if(exceptionType==null)
Trace.write("R3Player Unhandled exception: "+soapExceptionType+"\n Exception type not found");return exceptionType;}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.AddPlaylistButton=Class.create(CBCR3.Commons.EventDispatcher,{clickFunction:null,enabled:false,addButton:null,initialize:function($super){$super();this.addButton=$("add");this.addButton.observe("click",this.onClick.bind(this));},enable:function(){if(this.enabled)
return;this.addButton.removeAttribute("disabled");this.addButton.removeClassName("disabled");this.enabled=true;},setPermalink:function(permalink){if(permalink==null||permalink.blank())
this.disable();else
this.addButton.setAttribute("href",permalink);},disable:function(){this.addButton.setAttribute("disabled","disabled");this.addButton.addClassName("disabled");this.enabled=false;},onClick:function(event){}});

CBCR3.namespace("CBCR3.Player.Application");var _playerInstance;var _playerProviderInstance;CBCR3.Player.Application.R3PlayerInstanceService=Class.create({getProvider:function()
{if(_playerProviderInstance==null||_playerProviderInstance==undefined)
_playerProviderInstance=new CBCR3.Player.Application.R3PlayerProvider();return _playerProviderInstance;},getInstance:function()
{return this.getProvider().getInstance();},setInstance:function(instance)
{this.getProvider().setInstance(instance);},addEventListener:function(type,method)
{this.getProvider().addEventListener(type,method);}});CBCR3.Player.Application.R3PlayerProvider=Class.create(CBCR3.Commons.EventDispatcher,{initialize:function($super){$super();},getInstance:function(){return _playerInstance;},setInstance:function(instance){if(instance==null)
throw"Cannot set R3 Player if instance is null in R3 Player Provider";_playerInstance=instance;this.dispatchEvent(CBCR3.Player.Events.StateInitEvent.r3PlayerInit,{r3Player:_playerInstance},this);}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.PermalinkButton=Class.create(CBCR3.Commons.EventDispatcher,{track:null,overlay:null,permalinkButton:null,debug:false,initialize:function($super){$super();this.permalinkButton=$("permalink");this.permalinkButton.observe("click",this.permalink_Click.bind(this));this.disable();},setTrack:function(track){this.track=track;},enable:function(){this.permalinkButton.removeClassName("disabled");this.permalinkButton.removeAttribute("disabled");},disable:function(){$('permalink').addClassName("disabled");this.permalinkButton.setAttribute("disabled","disabled");},permalink_Click:function(event){Trace.write("permalink_click()",this.debug);if(Event.element(event).hasClassName('disabled'))
return;this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.sendPermalink,{permalink:this.track.permalink,title:this.track.artist+" - "+this.track.title});}});

CBCR3.namespace("CBCR3.Player");CBCR3.Player.R3Player=Class.create(CBCR3.Commons.EventDispatcher,{masterPlayer:null,playPause:null,voteButton:null,voteService:null,trackDisplay:null,progressScrubber:null,volumeScrubber:null,playlistPanel:null,trackTime:null,prevNext:null,thumbs:null,shuffle:null,favourite:null,buyLink:null,trackPanel:null,modeControls:null,permalinkButton:null,addPlaylistPanel:null,addPlaylistButton:null,helpButton:null,streamPanel:null,nodesocketservice:null,playlistService:null,permalinkService:null,thumbService:null,musicService:null,metaDataNotifier:null,cbcAdPlayed:"cbcmusic_ads",cbcGeoFenced:"cbcmusic_geofenced",adPlayerInstance:null,adMode:false,playExpiry:5,debug:false,browser:null,pageInitializer:null,isSearchlight:false,maxVotesPerQuestion:1,votedItems:null,mergedVotedItems:null,initialize:function($super,masterPlayer){$super();this.masterPlayer=masterPlayer;this.pageInitializer=new CBCR3.Application.PageInitializerProvider().getInstance();this.addModules();this.registerEvents();this.displayStopped();this.browser=this.browserVersion();this.maxVotesPerQuestion=_getPollMaxVotesPerQuestion();var self=this;document.observe('CBCR3:Searchlight:ItemVoted',function(evt){if(!_.isUndefined(evt.memo)){var data=evt.memo;if(data){if(self.voteButton.getAttribute('data-selection-id')==data.questionItemId){self.updateButtonStateToVoted();}}}});document.observe('CBCR3:Searchlight:LocalVotingDataDidUpdate',function(evt){if(!_.isUndefined(evt.memo)){var data=evt.memo;if(data&&self.voteButton){self.votedItems=data.votedItems;self.mergedVotedItems=data.mergedVotedItems;var questionId=self.voteButton.getAttribute('data-poll-question-id');if(self.votedItems&&!_.isUndefined(self.votedItems[questionId+'_items'])&&_.contains(_.keys(self.votedItems[questionId+'_items']),self.voteButton.getAttribute('data-selection-id'))){self.updateButtonStateToVoted();}else if(self.votedItems&&!_.isUndefined(self.votedItems[questionId+'_items'])&&_.keys(self.votedItems[questionId+'_items']).length>=self.maxVotesPerQuestion){self.updateButtonStateToDisabled();}else{self.voteButton.removeClassName('disabled');}}}});},browserVersion:function(){var userAgent=navigator.userAgent.toLowerCase();var platform=navigator.platform.toLowerCase();var browser={version:(userAgent.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[])[1],safariVersion:(userAgent.match(/safari\/(.*)/)||[])[1],platformMac:/mac/.test(platform),webkit:/webkit/.test(userAgent),opera:/opera/.test(userAgent),msie:/msie/.test(userAgent)&&!/opera/.test(userAgent),mozilla:/mozilla/.test(userAgent)&&!/(compatible|webkit)/.test(userAgent),userAgent:userAgent};return browser;},addModules:function(){this.permalinkService=CBCR3.Services.ServicesProvider.getInstanceOf("permalinkService");this.thumbService=CBCR3.Services.ServicesProvider.getInstanceOf("thumbService");this.musicService=CBCR3.Services.ServicesProvider.getInstanceOf("musicService");this.metaDataNotifier=new CBCR3.Player.Services.MetaDataNotifierProvider().getInstance();this.playPause=new CBCR3.Player.Modules.PlayPause(this.masterPlayer.getIsPlaying());this.playPause.addEventListener(CBCR3.Player.Events.PlaybackCommand.play,this.playPausePlayHandler.bind(this));this.playPause.addEventListener(CBCR3.Player.Events.PlaybackCommand.pause,this.playPausePauseHandler.bind(this));this.trackDisplay=new CBCR3.Player.Modules.TrackDisplay();this.trackDisplay.addEventListener(CBCR3.Player.Events.PermalinkEvent.retrievePermalinkContext,this.retrievePermalinkContextHandler.bind(this));this.trackTime=new CBCR3.Player.Modules.TrackTime();this.trackTime.addEventListener(CBCR3.Player.Events.TrackTimeEvent.changed,this.trackTimeChangedHandler.bind(this));this.prevNext=new CBCR3.Player.Modules.PrevNext(this.metaDataNotifier);this.prevNext.addEventListener(CBCR3.Player.Events.PlaybackEvent.prev,this.playbackPrevHandler.bind(this));this.prevNext.addEventListener(CBCR3.Player.Events.PlaybackEvent.next,this.playbackNextHandler.bind(this));this.prevNext.addEventListener(CBCR3.Player.Events.PlaylistEvent.permalinkSelected,this.permalinkSelectedHandler.bind(this)),this.prevNext.addEventListener(CBCR3.Player.Events.PlaylistEvent.permalinkAdded,this.permalinkAddedHandler.bind(this));this.favourite=new CBCR3.Player.Modules.Favourite(this.permalinkService);this.favourite.addEventListener(CBCR3.Player.Events.PermalinkEvent.favouriteStatus,this.favouriteStatusChangedHandler.bind(this));this.favourite.addEventListener(CBCR3.Player.Events.PermalinkEvent.favouriteAdded,this.favouriteAddedHandler.bind(this));this.favourite.addEventListener(CBCR3.Player.Events.AuthenticationEvent.loginRequired,this.loginRequiredHandler.bind(this));this.trackPanel=new CBCR3.Player.Modules.TrackPanel(this.musicService);this.trackPanel.addEventListener(CBCR3.Player.Events.PlaylistEvent.trackSelected,this.trackPanelSelectedHandler.bind(this));this.modeControls=new CBCR3.Player.Modules.ModeControls();this.modeControls.addEventListener(CBCR3.Player.Events.ModeControlEvent.playlist,this.playlistModeHandler.bind(this));this.modeControls.addEventListener(CBCR3.Player.Events.ModeControlEvent.browseTracks,this.browseTracksHandler.bind(this));this.modeControls.addEventListener(CBCR3.Player.Events.ModeControlEvent.browseStreams,this.browseStreamsHandler.bind(this));this.permalinkButton=new CBCR3.Player.Modules.PermalinkButton();this.permalinkButton.addEventListener(CBCR3.Player.Events.PermalinkEvent.sendPermalink,this.sendPermalinkHandler.bind(this));this.progressScrubber=new CBCR3.Player.Modules.ProgressScrubber();this.progressScrubber.addEventListener(CBCR3.Player.Events.ScrubEvent.changed,this.progressScrubberChangedHandler.bind(this));this.volumeScrubber=new CBCR3.Player.Modules.VolumeScrubber(this.masterPlayer.getVolume());this.volumeScrubber.addEventListener(CBCR3.Player.Events.ScrubEvent.slide,this.volumeScrubberSlideHandler.bind(this));this.volumeScrubber.addEventListener(CBCR3.Player.Events.ScrubEvent.changed,this.volumeScrubberChangedHandler.bind(this));this.addPlaylistButton=new CBCR3.Player.Modules.AddPlaylistButton();this.addPlaylistButton.addEventListener(CBCR3.Player.Events.PlaylistEvent.addPlaylistSelected,this.addPlaylistButtonSelectedHandler.bind(this));if(typeof CBCR3.Player.Players.AdPlayer!=='undefined'){this.adPlayerInstance=new CBCR3.Player.Players.AdPlayer({adZone:getCBCMusicAdZone(),svnRevision:_svnRevision,mode:CBCR3.environment().audioStreamPreRollMode});this.adPlayerInstance.addEventListener(CBCR3.Player.Events.StwCueEvent.adBreak,this.adOverrideStartHandler.bind(this));this.adPlayerInstance.addEventListener(CBCR3.Player.Events.Ads.adComplete,this.adCompleteHandler.bind(this));}
this.pageInitializer.addEventListener(CBCR3.Player.Events.StreamEvent.logInfo,this.logStartPlayingEvent.bind(this));},logAudioPlayEvent:function(eventInfo){if(typeof _gaq!='undefined'&&_gaq!=null){var pagePermalink="/";if(eventInfo.value!=null){var params=document.location.href.toQueryParams();pagePermalink=(params.permalink!=null&&params.permalink!="")?params.permalink:"/";}
_gaq.push(['_trackEvent',eventInfo.category,eventInfo.label,eventInfo.value]);_gaq.push(['_trackEvent','Page Play',pagePermalink,eventInfo.value]);}},logStartPlayingEvent:function(eventInfo){this.masterPlayer.logCurrentlyPlayingInfo({startTimeMs:new Date().getTime(),title:eventInfo.data.title,eventName:eventInfo.data.eventName,gaq:_gaq});},logStreamPlayEvent:function(event){var dataValue="";if(event==null||event.data==null){var params=document.location.href.toQueryParams();dataValue=(params.permalink!=null&&params.permalink!="")?params.permalink:"/";}else{dataValue=event.data;}
this.logAudioPlayEvent({category:'All Plays',label:'Stream Play',value:dataValue});},registerEvents:function(){this.masterPlayer.addEventListener(CBCR3.Player.Events.StatusEvent.notify,this.notificationHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.LoadingEvent.open,this.loadingOpenHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.LoadingEvent.progress,this.loadingProgressHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.LoadingEvent.buffering,this.loadingBufferingHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.PlaybackEvent.start,this.playbackStartHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.PlaybackEvent.progress,this.playbackProgressHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.PlaybackEvent.finished,this.playbackFinishedHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.PlaybackEvent.stream,this.playbackStreamHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.PlaybackExceptionEvent.emptyPlaylist,this.emptyPlaylistHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.PlaybackExceptionEvent.endOfPlaylist,this.endOfPlaylistHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.PlaybackExceptionEvent.nullPlaylist,this.nullPlaylistHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.PermalinkEvent.favouriteStatus,this.favouriteStatusHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.PermalinkEvent.permalinkContextReceived,this.permalinkContextReceivedHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.StreamEvent.metaData,this.metaDataReceivedHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.StreamEvent.metaDataConnected,this.metaDataConnectedHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.StreamEvent.metaDataStreamUpdated,this.streamUpdatedMetaDataHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.StwCueEvent.adBreak,this.adOverrideStartHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.StwCueEvent.endAdBreak,this.adOverrideStopHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.StreamEvent.connected,this.streamConnectedHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.StreamEvent.error,this.streamErrorHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.StreamEvent.blocked,this.streamBlockedHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.ServiceExceptionEvent.userOutsideCanada,this.trackBlockedHandler.bind(this));this.masterPlayer.addEventListener(CBCR3.Player.Events.RTMPStreamEvent.logPlayEvent,this.logStreamPlayEvent.bind(this));},initVoteButton:function(){var self=this;this.voteButton=$("playerVoteButton");this.voteService=CBCR3.Polling.Services.VotingServiceInstance.getInstance();this.voteService.addEventListener(CBCR3.Polling.Events.ServiceEvent.voteCollected,this.onVoteCollected.bind(this));this.voteService.addEventListener(CBCR3.Polling.Events.ServiceEvent.authenticationError,this.onAuthenticationError.bind(this));this.voteService.addEventListener(CBCR3.Polling.Events.ServiceEvent.voteError,this.onVoteError.bind(this));if(this.voteButton!=null){this.voteButton.observe("click",function(event){Event.stop(event);if(!$(event.target).hasClassName('disabled')){var pollId=event.target.readAttribute("data-poll-id");var questionId=event.target.readAttribute("data-poll-question-id");var selectionId=event.target.readAttribute("data-selection-id");self.voteService.collectVote(questionId,selectionId,pollId);}});}},updateVoteButtonHandler:function(event){var temp=event;},getVoteItems:function(item){var retVal=null;if(item!=null){retVal={pollId:item.readAttribute("data-poll-id"),selectionId:item.readAttribute("data-selection-id"),questionId:item.readAttribute("data-poll-question-id")};}
return retVal;},updateVoteItems:function(itemDto){this.updateButtonStateToNotVoted();if(this.voteButton!=null){this.voteButton.setAttribute("data-poll-id",itemDto.pollId);this.voteButton.setAttribute("data-selection-id",itemDto.selectionId);this.voteButton.setAttribute("data-question-poll-id",itemDto.questionId);}},onVoteCollected:function(event){var pollId=event.data.pollId||this.voteButton.getAttribute("data-poll-id");var questionId=event.data.questionId;var itemId=event.data.selectionId;if(this.voteButton.getAttribute('data-selection-id')==itemId){this.updateButtonStateToVoted();}
this.dispatchEvent(CBCR3.Polling.Events.ItemEvent.hasVoted,{questionId:questionId,questionItemId:itemId});document.fire('CBCR3:Searchlight:ItemVoted',{questionId:questionId,questionItemId:itemId});},updateButtonStateToEnabled:function(){if(this.voteButton){this.voteButton.removeClassName('disabled');}},updateButtonStateToDisabled:function(){if(this.voteButton){this.voteButton.addClassName('disabled');}},updateButtonStateToNotVoted:function(){if(this.voteButton){this.voteButton.removeClassName('saved');this.voteButton.removeClassName('disabled');this.voteButton.update('Vote');}},updateButtonStateToVoted:function(){if(this.voteButton){this.voteButton.addClassName('saved');this.voteButton.addClassName('disabled');this.voteButton.update('Voted');}},onAuthenticationError:function(){},onVoteError:function(){},notificationHandler:function(event){Trace.write("notificationHandler()",this.debug);Trace.write(event,this.debug);},updateSettings:function(roomid,permalink,mount,streamName){this.masterPlayer.updateSettings(roomid,permalink,mount,streamName);},setIsSearchlight:function(isSearchlight){this.shuffle=CBCR3.Player.ShuffleMode.shuffle;this.isSearchlight=isSearchlight;},unload:function(){Trace.write("Unload Player");this.masterPlayer.clearEventListeners();},playbackPrevHandler:function(event){this.updateSearchlightSettings();this.masterPlayer.prev(this.isSearchlight);},playbackNextHandler:function(event){this.updateSearchlightSettings();this.masterPlayer.next(this.isSearchlight);},playlistModeHandler:function(event){},browseTracksHandler:function(event){var track=this.masterPlayer.getTrack();var sequence=track?track.sequence:0;this.trackPanel.show(this.masterPlayer.getPermalink(),sequence);},browseStreamsHandler:function(event){this.streamPanel.show();},addPlaylistButtonSelectedHandler:function(event){try{return;}catch(e){Trace.write('error in addPlaylistButtonSelectedHandler',true);Trace.error(e);}},playPausePlayHandler:function(event){Trace.write("cbcmusicplayer.js -> playPausePlayHandler() adMode:"+this.adMode,this.debug);this.masterPlayer.play();},playPausePauseHandler:function(event){Trace.write("cbcmusicplayer.js -> playPausePauseHandler()",this.debug);this.masterPlayer.pause();},adOverrideStartHandler:function(event){Trace.write("cbcmusicplayer.js -> adOverrideStartHandler()",true);Trace.write(event,true);this.dispatchEvent(CBCR3.Player.Events.StwCueEvent.adBreak,{cuePoint:event.data.cuePoint});},adOverrideStopHandler:function(event){Trace.write("cbcmusicplayer.js -> adOverrideStopHandler() endAdBreak:"+CBCR3.Player.Events.StwCueEvent.endAdBreak,this.debug);Trace.write(event,this.debug);this.dispatchEvent(CBCR3.Player.Events.StwCueEvent.endAdBreak);},adCompleteHandler:function(event){Trace.write("adCompleteHandler() mastertemplate.js",true);Trace.write(event,true);this.adMode=false;this.dispatchEvent(CBCR3.Player.Events.StwCueEvent.endAdBreak);var audioStream=event.data.audioStream;CBCR3.Commons.Cookies.create(this.cbcAdPlayed,true,0,this.playExpiry);this.stream(audioStream.roomid,event.data.permalink,audioStream.mount,audioStream.name);},streamAudio:function(roomid,permalink,mount,streamName,playpreroll,prerollTarget){try{Trace.write("mastertemplate.js -> streamAudio() adPlayed cookie:"+CBCR3.Commons.Cookies.getValue(this.cbcAdPlayed),true);Trace.write("in play Ad:",true);this.masterPlayer.kill();this.trackDisplay.clear();if(!CBCR3.Commons.Cookies.getValue(this.cbcAdPlayed)&&playpreroll&&this.isValidBrowser()&&this.adPlayerInstance!=null){this.streamMetadataOnly(roomid,permalink,mount,streamName);this.stop();this.playPause.disable();this.adPlayerInstance.play({audioStream:{roomid:roomid,mount:mount,name:streamName},permalink:permalink,prerollTarget:prerollTarget});this.adMode=true;}else{Trace.write("Just Stream:",true);this.stream(roomid,permalink,mount,streamName);}}catch(e){Trace.error(e);}},isValidBrowser:function(){if(this.browser.platformMac&&this.browser.safariVersion){var svers_num=parseInt(this.browser.safariVersion.split(".")[0]);Trace.write("isValidBrowser() -> svers_num:"+svers_num,true);return(svers_num>533);}
return true;},streamMetadataOnly:function(roomid,permalink,mount,streamName){try{Trace.write("STREAM METADATA ONLY connecting: cbcmusicplayer.js - > stream() permalink:"+permalink+" mount:"+mount,this.debug);this.masterPlayer.setPlayerState({mode:CBCR3.Player.PlayerMode.stream});this.displayStreamMode(streamName);this.masterPlayer.setVolume(this.masterPlayer.getVolume());this.modeControls.streamMode();this.masterPlayer.updateSettings(roomid,permalink,mount,streamName);this.initPlayerButtons();this.playPause.setIsPlaying(false);this.metaDataNotifier.updatePermalink(permalink);this.playPause.enable();this.prevNext.disable();this.trackDisplay.enableNowPlaying();this.masterPlayer.joinRoom();}catch(e){Trace.error(e);}},stream:function(roomid,permalink,mount,streamName){try{Trace.write("STREAM connecting: cbcmusicplayer.js - > stream() permalink:"+permalink+" mount:"+mount,this.debug);this.masterPlayer.kill();this.trackDisplay.clear();this.adMode=false;this.masterPlayer.setPlayerState({mode:CBCR3.Player.PlayerMode.stream});this.displayStreamMode(streamName);this.masterPlayer.setVolume(this.masterPlayer.getVolume());this.modeControls.streamMode();this.masterPlayer.updateSettings(roomid,permalink,mount,streamName);this.initPlayerButtons();this.playPause.setIsPlaying(true);this.metaDataNotifier.updatePermalink(permalink);this.playPause.enable();this.prevNext.disable();this.trackDisplay.enableNowPlaying();this.masterPlayer.play();}catch(e){Trace.error(e);}},initPlayerButtons:function(){this.addPlaylistButton.disable();this.permalinkButton.disable();this.favourite.disable();},playlist:function(permalink){Trace.write("PLAYLIST connecting: cbcmusicplayer.js - > playlist()"+permalink,this.debug);if(this.adMode&&!this.isSearchlight)
return;this.masterPlayer.kill();var playerStateProps={isSearchlight:this.isSearchlight};if(this.masterPlayer.getPlayerState().mode!=CBCR3.Player.PlayerMode.playlist){playerStateProps.mode=CBCR3.Player.PlayerMode.playlist;}
this.masterPlayer.setPlayerState(playerStateProps);this.modeControls.playlistMode();this.masterPlayer.setPermalink(permalink);this.masterPlayer.clearTrack();this.masterPlayer.setVolume(this.masterPlayer.getVolume());this.displayPlaylistMode();this.metaDataNotifier.updatePermalink(permalink);this.playPause.enable();this.prevNext.enable();this.trackDisplay.enableNowPlaying();if(this.isSearchlight)
this.masterPlayer.setShuffleMode(CBCR3.Player.ShuffleMode.shuffle);var sequence=this.getSequenceFrom(permalink);if(sequence)
this.masterPlayer.playTrack(sequence,this.isSearchlight);else{this.masterPlayer.next(this.isSearchlight);}},getSequenceFrom:function(permalink){var indexOfHash=permalink.indexOf("#");return indexOfHash!=-1?parseInt(permalink.substring(indexOfHash+1,permalink.length)):0;},resume:function(){var playerState=this.masterPlayer.getPlayerState();Trace.write("cbcmusicplayer.js -> resume()",this.debug);Trace.write(playerState,this.debug);if(this.masterPlayer.getTrack()==null){this.resumeNullTrackState();return;}
if(playerState.mode==CBCR3.Player.PlayerMode.playlist){this.setIsSearchlight(playerState.isSearchlight!=null&&playerState.isSearchlight);if(playerState.isSearchlight)
this.dispatchEvent(CBCR3.Player.Events.ServiceEvent.trackReceived,{track:this.masterPlayer.getTrack()});this.resumePlaylistState();}else this.resumeStreamState();var track=this.masterPlayer.getTrack();var showComposer=false;if(playerState.mode==CBCR3.Player.PlayerMode.stream){var stream=getAudioStreamManager().getStreamByPermalink(this.masterPlayer.getPermalink());showComposer=(stream==null||!stream.showcomposer)?false:stream.showcomposer;}
this.setDisplay(track.artist,track.title,track.infoLink,track.iTunesLink,track.type,showComposer,track.composer,track.composerPermalink);this.setPermalinkButtons(track);this.playPause.setIsPlaying(this.masterPlayer.getIsPlaying());this.metaDataNotifier.updateCBCMusicMetaData(playerState.streamMetaData);this.metaDataNotifier.updatePermalink(this.masterPlayer.getPermalink());this.playPause.enable();if(playerState.mode==CBCR3.Player.PlayerMode.playlist)
this.prevNext.enable();this.trackDisplay.enableNowPlaying();this.addPlaylistButton.enable();this.addPlaylistButton.setPermalink(track.permalink);},resumeNullTrackState:function(){Trace.write("resumeNullTrackState()",false);var playerState=this.masterPlayer.getPlayerState();this.displayStopped();this.setDisplay(playerState.message,playerState.details);if(playerState.mode==CBCR3.Player.PlayerMode.playlist){this.playPause.enable();this.playPause.setIsPlaying(this.masterPlayer.getIsPlaying());this.prevNext.enable();this.prevNext.setPlaylistMode();}},resumePlaylistState:function(){this.displayPlaylistMode();this.modeControls.playlistMode(true);this.progressScrubber.enable();this.trackTime.setTimeCount(this.masterPlayer.getTimeCount());var progress=this.masterPlayer.getProgress();this.trackTime.update(progress.position,progress.end);this.progressScrubber.updatePercentLoaded(this.masterPlayer.getPercentLoaded());this.progressScrubber.updatePosition(progress.position,progress.end);this.favourite.load(this.masterPlayer.getPermalink(),this.masterPlayer.getPlayerState().favouriteStatus);},resumeStreamState:function(){Trace.write("resumeStreamState()",this.debug);var playerState=this.masterPlayer.getPlayerState();var streamName=this.masterPlayer.getStreamName();this.displayStreamMode(streamName);this.modeControls.streamMode();if(playerState.status!=CBCR3.Player.PlayerStatus.inTransition)
this.progressScrubber.hideBuffering();},displayStreamMode:function(streamName){this.progressScrubber.disable();this.trackTime.hide();this.prevNext.setStreamMode();this.progressScrubber.reset();this.initPlayerButtons();if(streamName!=null&&streamName!="")
this.progressScrubber.displayStreamInfo(streamName);},displayPlaylistMode:function(){this.progressScrubber.reset();this.progressScrubber.enable();this.trackTime.show();this.prevNext.setPlaylistMode();this.initPlayerButtons();},displayStopped:function(){this.trackTime.hide();this.progressScrubber.disable();this.progressScrubber.hideBuffering();this.progressScrubber.reset();this.playPause.setIsPlaying(this.masterPlayer.getIsPlaying());this.favourite.disable();this.addPlaylistButton.disable();this.permalinkButton.disable();this.favourite.disable();this.trackDisplay.disableiTunesButton();if(this.masterPlayer.getPlayerState().mode==CBCR3.Player.PlayerMode.playlist)
this.modeControls.playlistMode();if(this.masterPlayer.getPlayerState().mode==CBCR3.Player.PlayerMode.stream)
this.modeControls.streamMode();},metaDataConnectedHandler:function(){Trace.write("metaDataConnectedHandler() in cbcmusicplayer.js",this.debug);this.progressScrubber.hideBuffering();},metaDataReceivedHandler:function(event){try{Trace.write("metaDataReceivedHandler() in cbcmusicplayer.js",this.debug);Trace.write(event,this.debug);Trace.write(event,this.debug);var track=event.data.metaData.track;Trace.write(track,this.debug);this.setDisplay(track.artist,track.title,track.infoLink,track.iTunesLink,"track");this.metaDataNotifier.updateCBCMusicMetaData(event.data.metaData);}catch(e){Trace.error(e);}},streamUpdatedMetaDataHandler:function(event){Trace.write("Stream Updated in CBC Music Player",this.debug);Trace.write(event,this.debug);this.metaDataNotifier.updateCBCMusicMetaData(event.data.value);},streamSelectedHandler:function(event){Trace.write("*** STREAM SELECTED: cbcmusicplayer.js -> streamSelectedHandler()");this.stream(event.data.streamPermalink);},streamConnectedHandler:function(event){Trace.write("*** STREAM CONNECTED: cbcmusicplayer.js -> streamConnectedHandler()",this.debug);},shuffleChangedHandler:function(event){var shuffleMode=event.data.shuffleMode;this.masterPlayer.setShuffleMode(shuffleMode);},thumbChangedHandler:function(event){this.sendThumbChangedHandler(event);},retrievePermalinkContextHandler:function(event){this.masterPlayer.retrievePermalinkContext();},permalinkContextReceivedHandler:function(event){Trace.write("cbcmusicplayer.js -> permalinkContextReceivedHandler()");Trace.write(event);this.trackDisplay.setContextData(event.data.permalinkContext);},trackPanelSelectedHandler:function(event){var track=event.data.track;this.masterPlayer.playTrack(track.sequence);},permalinkSelectedHandler:function(event){this.playlist(event.data.permalink);},permalinkAddedHandler:function(event){this.showAddPlaylistPanel(event.data.permalink);},loadingOpenHandler:function(event){this.progressScrubber.reset();this.masterPlayer.retrieveFavouriteStatus();this.addPlaylistButton.enable();},loadingProgressHandler:function(event){this.progressScrubber.updatePercentLoaded(event.data.percentLoaded);},loadingBufferingHandler:function(event){},setDisplay:function(title,subTitle,infoLink,iTunesLink,type,showcomposer,composerText,composerPermalink){try{Trace.write("setDisplay "+showcomposer,this.debug);Trace.write("track display-> title:"+title+" infoLink:"+infoLink+" Ituneslink:"+iTunesLink+" showcomposer:"+showcomposer+" type:"+type+" composer:"+composerText+" composerlink:"+composerPermalink,this.debug);if(this.adPlayerInstance!=null)
this.trackDisplay.setAdActive(this.adPlayerInstance.isActive());this.trackDisplay.setDisplay(title,subTitle,infoLink,iTunesLink,type,showcomposer,composerText,composerPermalink);}catch(e)
{Trace.error(e);}},updateSearchlightSettings:function(){if(this.isSearchlight&&_searchlightPlayer&&_searchlightPlayer.promoUrl!=null)
this.masterPlayer.setPermalink(_searchlightPlayer.promoUrl);},playbackStartHandler:function(event){Trace.write("***> CBC Music Player playbackStartHandler",true);this.progressScrubber.enable();this.trackTime.show();this.playPause.enable();this.playPause.setIsPlaying(true);this.progressScrubber.hideBuffering();var track=this.masterPlayer.getTrack();var stream=getAudioStreamManager().getStreamByPermalink(this.masterPlayer.getPermalink());var itemPermalink=track.permalink;var position=event.data.position;if(stream==null&&position==0){this.logAudioPlayEvent({category:'All Plays',label:'Track Play',value:itemPermalink});}
var showComposer=(stream==null||!stream.showcomposer)?false:stream.showcomposer;this.setDisplay(track.artist,track.title,track.infoLink,track.iTunesLink,track.type,showComposer,track.composer,track.composerPermalink);this.setPermalinkButtons(track);this.trackPanel.update(track.sequence);this.metaDataNotifier.updatePermalink(this.masterPlayer.getPermalink());},playbackProgressHandler:function(event){var progress=event.data.progress;this.progressScrubber.updatePosition(progress.position,progress.end);this.trackTime.update(progress.position,progress.end);},playbackFinishedHandler:function(event){this.progressScrubber.disable();this.trackTime.hide();this.updateSearchlightSettings();this.masterPlayer.next(this.isSearchlight);},playbackStreamHandler:function(event){try{Trace.write("playbackStreamHandler: ",this.debug);var track=this.masterPlayer.getTrack();var stream=getAudioStreamManager().getStreamByPermalink(this.masterPlayer.getPermalink());var showComposer=(stream!=null)?stream.showcomposer:false;Trace.write("track ",this.debug);Trace.write(track,this.debug);if(track.isGeoFenced){this.playPause.setIsPlaying(false);this.playPause.disable();}else{this.setPermalinkButtons(track);this.setAddPlaylistButton(track);}
this.showiTunesButton(true);this.setDisplay(track.artist,track.title,track.infoLink,track.iTunesLink,track.type,showComposer,track.composer,track.composerPermalink);if(this.isSearchlight){this.dispatchEvent(CBCR3.Player.Events.ServiceEvent.trackReceived,{track:track});this.updateVoteButton(track);}else{this.hideVoteButton();}
this.progressScrubber.hideBuffering();}catch(e){Trace.error(e);}},showiTunesButton:function(show){var itunesButton=$$('#r3player .playerButton.iTunes');if(itunesButton==null)
return;if(show)
itunesButton.invoke('show');else
itunesButton.invoke('hide');},hideVoteButton:function(){var playerVoteButton=$("playerVoteButton");if(playerVoteButton!=null){playerVoteButton.hide();}},updateVoteButton:function(track){var playerVoteButton=$("playerVoteButton");if(playerVoteButton!=null){if(this.maxVotesReached)
this.updateButtonStateToNotVoted();var hideVoteButtonFlag;if(typeof votingEnabled!='undefined'){hideVoteButtonFlag=!votingEnabled;}else{hideVoteButtonFlag=true;}
if(track==null)
hideVoteButtonFlag=true;if(hideVoteButtonFlag){playerVoteButton.hide();return;}
var pollId=track.pollId;var pollQuestionId=track.pollQuestionId;var pollQuestionItemId=track.pollQuestionItemId;if(pollId==null||pollQuestionId==null||pollQuestionItemId==null){playerVoteButton.hide();return;}
Web.polls.services.PollWebService.GetPollVotedSearchResults(pollId,this.didReceiveVotedItems.bind(this),function(){Trace.write("ERROR: ",true);Trace.write(arguments,true);});playerVoteButton.setAttribute("data-selection-id",pollQuestionItemId);playerVoteButton.setAttribute("data-poll-id",pollId);playerVoteButton.setAttribute("data-poll-question-id",pollQuestionId);this.showiTunesButton(false);playerVoteButton.setStyle({display:'block'});playerVoteButton.addClassName('disabled');playerVoteButton.show();}},didReceiveVotedItems:function(response){var playerVoteButton=$("playerVoteButton");var questionId=playerVoteButton.getAttribute('data-poll-question-id');var questionItemId=playerVoteButton.getAttribute('data-selection-id');if(_.contains(_.pluck(response,'Id'),playerVoteButton.getAttribute('data-selection-id'))){this.updateButtonStateToVoted();}else if(this.votedItems&&!_.isUndefined(this.votedItems[questionId+'_items'])&&_.keys(this.votedItems[questionId+'_items']).length>=this.maxVotesPerQuestion){this.updateButtonStateToDisabled();}else if((typeof _artistSearchlightMaxVotesReached!='undefined'&&_artistSearchlightMaxVotesReached.hasReachedMaxVotes&&_artistSearchlightMaxVotesReached.pollQuestionId==questionId)||(typeof _artistSearchlightHasVoted!='undefined'&&_artistSearchlightHasVoted.hasVoted&&_artistSearchlightHasVoted.pollQuestionItemId==questionItemId)){this.updateButtonStateToDisabled();}else{this.updateButtonStateToNotVoted();}},setPermalinkButtons:function(track){try{Trace.write("setPermalinkButtons:",this.debug);Trace.write(track,this.debug);if(!track||track.permalink==null||track.permalink.blank()){this.permalinkButton.disable();this.favourite.disable();}else{this.favourite.load(track.permalink,this.masterPlayer.getPlayerState().favouriteStatus);this.favourite.enable();this.permalinkButton.setTrack(track);this.permalinkButton.enable();}}catch(e){Trace.write('error in setPermalinkButtons',true);Trace.error(e);}},setAddPlaylistButton:function(track){try{Trace.write("setAddPlaylistButton:"+track,this.debug);if((!track||!track.permalink)||track.permalink.blank())
this.addPlaylistButton.disable();else{this.addPlaylistButton.enable();this.addPlaylistButton.setPermalink(track.permalink);}}catch(e){Trace.write('error in setAddPlaylistButton',true);Trace.error(e);}},emptyPlaylistHandler:function(event){this.displayStopped();this.modeControls.disableTrackPanel();},endOfPlaylistHandler:function(event){this.masterPlayer.clearTrack();this.displayStopped();},nullPlaylistHandler:function(event){this.masterPlayer.clearTrack();this.displayStopped();this.modeControls.disableTrackPanel();},streamErrorHandler:function(event){Trace.write("streamErrorHandler() in cbcmusicplayer.js",true);this.masterPlayer.clearTrack();this.displayStopped();},streamBlockedHandler:function(event){this.masterPlayer.clearTrack();this.displayStopped();if(CBCR3.Commons.Cookies.getValue(this.cbcGeoFenced)!=null)
return;CBCR3.Commons.Cookies.create(this.cbcGeoFenced,true,3650);TINY.box.show({html:this.blockedTemplate(),width:280,height:400,animate:false,close:true,top:20,maskopacity:this.maskopacity,boxid:"outsidecanadamodal"});},trackBlockedHandler:function(event){try{Trace.write("trackBlockedHandler()",true);this.playbackStreamHandler(event);TINY.box.show({html:this.blockedTrackTemplate(),width:280,animate:false,close:true,maskopacity:this.maskopacity,boxid:"outsidecanadatrackmodal"});}catch(e){Trace.error(e);}},blockedTrackTemplate:function(){return"<div class=\"headerInfo\"></div>"+"<div class=\"geoFenceHeader\"></div>"+"<div class=\"content\"><p class=\"headerContent\">However, the vast majority of our content remains open to all.</p>"+"<p>Take a moment to browse one of the sections below.</p>"+"<p><a href=\"/artists\">Artists</a><br/><a href=\"/concerts\">Concerts on Demand</a><br/><a href=\"/programs\">Podcasts & Programs</a><br/>"+"<img class=\"flag\" src=\"/lib/cbcmusic/images/modal/flag.png\" alt=\"Canada\"/>"+"</p></div>"+"<div class=\"footerInfo\"><a href=\"/faq/faq.aspx\" class=\"label\">Are you in Canada? Please see our FAQ.</a></div>";},blockedTemplate:function(){return"<div class=\"headerInfo\">Welcome Non-Canadians</div>"+"<div class=\"loginHeader\">Our cutting-edge Canadian technology indicates that you're visiting from outside of Canada.</div>"+"<div><p class=\"headerContent\">Good news you're free to sign up, browse and enjoy all of the great content here at CBC Music. We don't even need to see your passport</p>"+"<p>Please note that some parts of our streaming music service may not be accessible from outside of Canada. This is due to legal issues around"+" the licensing of music. Fortunately, however, the majority of our content is open to all, and we do hope you enjoy it. <b>Thank you for visiting.</b></p></div>"+"<div class=\"footerInfo\"><a href=\"/membersignup\" class=\"label\">sign up for your free <img src=\"../images/cbcmusiclogo_sm.png\" alt=\"CBC Music\" title=\"CBC Music\"> account.</a></div>";},favouriteStatusHandler:function(event){this.favourite.load(this.masterPlayer.getPermalink(),event.data.favouriteStatus);},favouriteStatusChangedHandler:function(event){this.masterPlayer.setPlayerState({favouriteStatus:event.data.favouriteStatus});},progressScrubberChangedHandler:function(event){this.masterPlayer.scrubTo(event.data.percent);},volumeScrubberSlideHandler:function(event){this.masterPlayer.setVolume(event.data.percent);},volumeScrubberChangedHandler:function(event){if(this.adMode&&this.adPlayerInstance!=null)
this.adPlayerInstance.setVolume(event.data.percent);else{this.masterPlayer.setVolume(event.data.percent);this.masterPlayer.saveVolume(event.data.percent);}},showAddPlaylistPanel:function(trackPermalink){Trace.write("cbcmusicplayer.js -> showAddPlaylistPanel() trackPermalink:"+trackPermalink,this.debug);var activePlaylistPermalink=this.masterPlayer.getPermalink();this.addPlaylistPanel.setPermalinks(activePlaylistPermalink,trackPermalink);this.addPlaylistPanel.show();},loginRequiredHandler:function(event){this.dispatchEvent(CBCR3.Player.Events.AuthenticationEvent.loginRequired,event.data);},trackTimeChangedHandler:function(event){this.masterPlayer.setTimeCount(event.data.timeCount);},playPermalink:function(permalink){this.playlist(permalink);},addTrack:function(permalink){this.showAddPlaylistPanel(permalink);},addToFavourites:function(permalink){this.favourite.addLike(permalink);},stop:function(){this.masterPlayer.stop();},pause:function(){this.masterPlayer.pause();this.playPause.setIsPlaying(false);},play:function(){this.masterPlayer.play();this.playPause.setIsPlaying(true);},trackAddedHandler:function(event){this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.trackAdded,{playlistPermalink:event.data.playlistPermalink,trackPermalink:event.data.trackPermalink,sequence:event.data.sequence});},favouriteAddedHandler:function(event){this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.favouriteAdded,{playlistPermalink:event.data.playlistPermalink});},favouriteRemovedHandler:function(event){this.masterPlayer.retrieveFavouriteStatus();this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.favouriteRemoved,{playlistPermalink:event.data.playlistPermalink});},newPlaylistCreatedHandler:function(event){this.dispatchEvent(CBCR3.Player.Events.PlaylistEvent.newPlaylistCreated,{playlistPermalink:event.data.playlistPermalink});},sendPermalinkHandler:function(event){this.dispatchEvent(CBCR3.Player.Events.PermalinkEvent.sendPermalink,{permalink:event.data.permalink,title:event.data.title});},sendThumbChangedHandler:function(event){this.dispatchEvent(CBCR3.Player.Events.ThumbEvent.changed,{thumbStatus:event.data.thumbStatus});}});

CBCR3.namespace("CBCR3.Player.Modules");CBCR3.Player.Modules.Mp3Button=Class.create(CBCR3.Commons.EventDispatcher,{metaDataNotifier:null,mp3Button:null,initialize:function($super,metaDataNotifier)
{$super();this.mp3Button=$("mp3Stream");this.mp3Button.observe("click",this.mp3Button_Click.bind(this));this.metaDataNotifier=metaDataNotifier;this.metaDataNotifier.addEventListener(CBCR3.Player.Events.ServiceEvent.permalinkChanged,this.permalinkChangedHandler.bind(this));},permalinkChangedHandler:function(event)
{this.checkAndSetState();},checkAndSetState:function()
{if(this.metaDataNotifier.getActiveStream()!=null)
this.enable();else this.disable();},mp3Button_Click:function(event)
{if(this.metaDataNotifier.getActiveStream())
window.open(this.metaDataNotifier.getActiveStream().shoutcastUrl);},enable:function()
{this.mp3Button.removeClassName("disabled");this.mp3Button.removeAttribute("disabled");},disable:function()
{this.mp3Button.addClassName("disabled");this.mp3Button.setAttribute("disabled","disabled");}});

CBCR3.namespace("CBCR3.Player.Mappers");CBCR3.Player.Mappers.PlaylistTrackDtoMapper=Class.create(CBCR3.Commons.MapperBase,{mapFrom:function(dto)
{return new CBCR3.Player.Models.PlaylistTrack({title:dto.Title,artist:dto.Artist,sequence:dto.Sequence,type:dto.Type,duration:dto.LengthInSeconds,audioUrl:dto.AudioUrl,infoLink:dto.InfoLink,artistPermalink:dto.ArtistPermalink,permalink:dto.Permalink,thumb:dto.Thumb,thumbnail:dto.Thumbnail,thumbnail3x4:dto.Thumbnail3x4,iTunesLink:dto.iTunesLink,trackId:dto.TrackId,uniqueHash:dto.UniqueHash,isGeoFenced:dto.IsGeoFenced,pollId:dto.PollId,pollQuestionId:dto.PollQuestionId,pollQuestionItemId:dto.PollQuestionItemId,shortTitle:dto.ShortTitle,shouldPlayInSequenceMode:dto.ShouldPlayInSequenceMode,isType:"js Source cbcPlayer"});}});

CBCR3.namespace("CBCR3.Player.Mappers");CBCR3.Player.Mappers.PlaylistDtoMapper=Class.create(CBCR3.Commons.MapperBase,{trackMapper:null,initialize:function($super){$super();this.trackMapper=new CBCR3.Player.Mappers.PlaylistTrackDtoMapper();},mapFrom:function(dto){return new CBCR3.Player.Models.Playlist({title:dto.Title,permalink:dto.Permalink,trackcount:dto.TrackCount,lastmodified:dto.LastModified,tracks:this.trackMapper.mapCollection(dto.Tracks)});}});

CBCR3.namespace("CBCR3.Player.Services");var _metaDataNotifierInstance;CBCR3.Player.Services.MetaDataNotifierProvider=Class.create({getInstance:function(){if(_metaDataNotifierInstance==null){_metaDataNotifierInstance=new CBCR3.Player.Services.MetaDataNotifier();}
return _metaDataNotifierInstance;}});CBCR3.Player.Services.MetaDataNotifier=Class.create(CBCR3.Commons.EventDispatcher,{metaData:null,permalink:null,fullMetaData:null,initialize:function($super){$super();},updatePermalink:function(permalink){this.permalink=permalink;this.dispatchEvent(CBCR3.Player.Events.ServiceEvent.permalinkChanged,{permalink:permalink});},updateMetaData:function(metaData){Trace.write("** Update Meta Data ** ",false);Trace.write(metaData);this.metaData=metaData;this.fullMetaData=metaData;Trace.write("after UpdateMetaData",false);Trace.write(metaData,false);this.dispatchEvent(CBCR3.Player.Events.ServiceEvent.metaDataUpdated,{metaData:metaData});},updateMetaDataCategory:function(metadata){var fullMetadata=CBCR3.MetaDataTest.SampleMetaDataProvider.getInstance().getMetaData();this.updateCBCMusicMetaData(this.fullMetaData);},updateCBCMusicMetaData:function(metaData){Trace.write("** Update CBC Music Meta Data ** ",false);Trace.write(metaData,false);this.fullMetaData=metaData;this.dispatchEvent(CBCR3.Player.Events.ServiceEvent.cbcMusicMetaDataUpdated,{metaData:this.fullMetaData});},getCBCMusicActiveStream:function(){if(this.metaData){return this.metaData.get(this.permalink);}
return null;},getActiveStream:function(){if(this.metaData){return this.metaData.get(this.permalink);}
return null;}});

CBCR3.namespace("CBCR3.Player.Services");CBCR3.Player.Services.StatsService={trackLink:function(event,options){var opts=options||{};if(!opts.linkPos)
opts.linkPos="R3Player";CBCR3.Stats.UI.trackLink(event,opts);}};

CBCR3.namespace("CBCR3.Player.Players");var _adPlayer=null;var _interval;CBCR3.Player.Players.AdPlayerProvider={getInstance:function(){if(_adPlayer==null)
_adPlayer=new CBCR3.Player.Players.AdPlayer();return _adPlayer;}};CBCR3.Player.Players.AdPlayer=Class.create(CBCR3.Commons.EventDispatcher,{isPlaying:false,service:null,adPlayerId:null,vidPreRollId:"vidAdPreRoll",permalink:null,audioStream:null,streamCategory:null,streamName:null,counter:0,svnRevision:null,ordNumber:0,mode:null,volume:70,height:10,width:100,status:"notinitiated",statusTypes:{playing:"playing",completed:"completed",notinitiated:"notinitiated",initiated:"initiated"},debug:true,testIndex:0,testTypes:["html","swf","iframe"],adzone:"music",bigBoxAdId:"cbc-big-box-ad1",bigBoxAd:null,initialize:function($super,opts){$super();this.adPlayerId="adPlayer";this.svnRevision=opts.svnRevision;this.mode=opts.mode||"audio";this.adzone=opts.adZone||"music";if(this.mode!="audio"){this.adPlayerId+="Video";$("vidAdPreRoll").hide();}
this.bigBoxAd=$(this.bigBoxAdId);},getAdName:function(){return"cbc_ad_"+this.counter++;},setAdZone:function(adZone){this.adzone=adZone;},setVolume:function(volume){this.volume=volume;},isActive:function(){return(this.status!=this.statusTypes.notinitiated);},getRandomNumber:function(){return Math.floor(Math.random()*10101010101);},getOrdNumber:function(newOne){if(newOne)
this.ordNumber=this.getRandomNumber();return this.ordNumber;},setup:function(prerollTarget){try{Trace.write("in adPlayer setup()",true);if(this.mode!="audio"){this.height=350;this.width=620;if($(this.adPlayerId+"_wrapper"))
$(this.adPlayerId+"_wrapper").remove();$(this.vidPreRollId).update(new Element("div",{id:this.adPlayerId}));$(this.vidPreRollId).insert(this.getVideoPreRollMessage());}
var adzoneParam=(prerollTarget!=null)?prerollTarget:this.adzone;var self=this;var tagCall="http://ad.doubleclick.net/pfadx/cbc.music.ca/"+this.adzone+";sz=300x300;show=;season=;section="+this.adzone+";shortClip=false;audioonly=true;companions=true;ord="+this.getOrdNumber(true)+";tile=3;";if(this.testIndex==this.testTypes.length)
this.testIndex=0;if(this.mode!="audio"){tagCall="http://ad.doubleclick.net/N5876/pfadx/cbc.music.ca/"+adzoneParam+";sz=320x240;"+this.getTargets()+"companions=false;section="+adzoneParam+";tile=1;ord="+this.getOrdNumber(true)+";dcmt=text/xml";if(this.bigBoxAd!=null){Element.writeAttribute(this.bigBoxAd,"id","tempCBCBIGBox");}}
jwplayer(this.adPlayerId).setup({flashplayer:"../lib/jwplayer/player.swf?v="+this.svnRevision,"controlbar.position":"bottom","controlbar":"over",stretching:"full",width:this.width,height:this.height,volume:this.volume,allowCompanions:false,autostart:true,plugins:{'googima':{ad:{cbc_ad:{tag:tagCall,type:"video",position:"pre",targets:['advert300x250']}},allowvolumeslider:true,events:{onAdComplete:self.adComplete.bind(self),onAdError:self.adError.bind(self,"adError"),onAdNotAvailable:self.adError.bind(self,"adNotAvailable"),onAdDismissed:self.adError.bind(self,"adDismissed"),onAdStart:self.adStart.bind(self)}}}});}catch(e){Trace.error(e);}},adStart:function(event){try{Trace.write("adplayer.js -> adStart():",true);Trace.write(event,true);Trace.write("interval",true);Trace.write(_interval,true);window.clearInterval(_interval);_interval=-1;this.status=this.statusTypes.playing;if(this.mode=="audio"){this.dispatchEvent(CBCR3.Player.Events.StwCueEvent.adBreak,{cuePoint:{'adURL':'http://ad.doubleclick.net/adi/cbc.music.ca/'+this.adzone+';sz=300x250;show=;season=;section='+this.adzone+';shortClip=false;audioonly=true;companions=true;ord='+this.getOrdNumber(false)+';tile=4;'}});}}catch(e)
{Trace.error(e);}},adError:function(event,errorSrc){Trace.write("adplayer.js -> adError():"+errorSrc,true);Trace.write(event,true);Trace.write(_interval,true);window.clearInterval(_interval);_interval=-1;this.status=this.statusTypes.notinitiated;ShowPageError("openVideoDiv() exception:",event);this.adComplete();},adComplete:function(){try{Trace.write("adplayer.js -> adComplete():",true);if(this.bigBoxAd!=null)
Element.writeAttribute(this.bigBoxAd,"id",this.bigBoxAdId);this.stop();this.dispatchEvent(CBCR3.Player.Events.Ads.adComplete,{permalink:this.permalink,audioStream:this.audioStream});}catch(e){Trace.error(e);}},stop:function(){try{Trace.write("adPlayer() stop()",true);this.status=this.statusTypes.notinitiated;jwplayer(this.adPlayerId).stop();if(this.mode!="audio"){this.closeVideoDiv();}
this.dispatchEvent(CBCR3.Player.Events.Ads.adComplete,{audioStream:this.audioStream,permalink:this.permalink});}catch(e){Trace.error(e);}},pausePlay:function(){try{Trace.write("adplayer.js -> pausePlay(): ",true);jwplayer(this.adPlayerId).pause();}catch(e){Trace.error(e);}},playInJwPlayer:function(prerollTarget){try{Trace.write("playInJwPlayer",true);var self=this;this.setup(prerollTarget);jwplayer(this.adPlayerId).load({file:"/advertising/error.flv?v="+self.getRandomNumber(),autostart:true,"controlbar.position":"bottom",onBeforePlay:self.stop.bind(self)});this.status=this.statusTypes.initiated;_interval=window.setInterval(this.checkAdStart.bind(this),6000);}catch(e){Trace.error(e);}},openVideoDiv:function(prerollTarget){try{var self=this;var vidPreRoll=$("vidAdPreRoll");this.setVolume(this.volume);vidPreRoll.show();vidPreRoll.morph('height:385px;width:620px;float:left;margin-bottom:20px;display:block;position:relative;',{duration:0.8,afterFinish:function(){self.playInJwPlayer(prerollTarget);var div=vidPreRoll.down("div");if(div)
div.addClassName("show");}});}catch(e){Trace.error(e);}},checkAdStart:function(){if(this.status==this.statusTypes.initiated){Trace.write("interval",true);Trace.write(_interval,true);window.clearInterval(_interval);_interval=-1;this.adError(this,"Ad Not Initiated in Time PerEx");}},getVideoPreRollMessage:function(){return"<div id=\"adPreRollMsg\">Your Radio Stream Will Begin playing after this brief message from our sponsors</div>";},closeVideoDiv:function(){var vidPreRoll=$("vidAdPreRoll");vidPreRoll.morph('height:0px;width:620px;float:left;margin-bottom:0px;display:block;',{duration:0.8,afterFinish:function(){vidPreRoll.hide();var div=vidPreRoll.down("div");if(div)
div.removeClassName("show");}});},play:function(opts){try{this.setCategoryStreamQS(opts.permalink);this.permalink=opts.permalink;this.audioStream=opts.audioStream;if(opts.permalink!=null&&opts.permalink.toLowerCase().indexOf("/stream/genre/classical")>-1)
this.volume=50;Trace.write("adPlayer - play() mode:"+this.mode,true);if(this.mode=="audio")
this.playInJwPlayer();else
this.openVideoDiv(opts.prerollTarget);}catch(e){Trace.error(e);}},pause:function(){},setCategoryStreamQS:function(permalink){var parts=permalink.split('/');if(parts.length==5){this.streamCategory=parts[3];this.streamName=parts[4];}},getTargets:function(){var retVal;retVal=(this.streamCategory)?"category="+this.streamCategory+";":"";retVal=(this.streamName)?retVal+"stream="+this.streamName+";":retVal;return retVal;}});
